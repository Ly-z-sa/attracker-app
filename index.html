<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Tracker</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%238B4513'/%3E%3Cpath d='M25 35h50v8H25z' fill='%23FFF8DC'/%3E%3Cpath d='M25 48h50v8H25z' fill='%23FFF8DC'/%3E%3Cpath d='M25 61h50v8H25z' fill='%23FFF8DC'/%3E%3Ccircle cx='20' cy='39' r='3' fill='%2328a745'/%3E%3Ccircle cx='20' cy='52' r='3' fill='%23dc3545'/%3E%3Ccircle cx='20' cy='65' r='3' fill='%2328a745'/%3E%3C/svg%3E" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Italiana&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #8B4513;
            --primary-light: #A0522D;
            --primary-dark: #654321;
            --secondary: #D2691E;
            --accent: #CD853F;
            --light-grey: #F5F5DC;
            --bg-color: #FFF8DC;
            --dark-text: #2F1B14;
            --grey-text: #8B7355;
            --light-text: #ffffff;
            --green: #228B22;
            --green-dark: #006400;
            --red: #B22222;
            --red-dark: #8B0000;
            --blue-accent: #4682B4;
            --blue-accent-dark: #2F4F4F;
            --yellow: #DAA520;
            --yellow-dark: #B8860B;
            --border-color: #DEB887;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(139, 69, 19, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Italiana', 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--dark-text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--light-text);
            padding: 1.25rem 2.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-header h1 {
            font-size: 1.75rem;
            font-weight: 600;
        }

        .app-nav {
            display: flex;
            gap: 1.5rem;
        }

        .nav-link {
            color: var(--light-text);
            text-decoration: none;
            font-size: 1rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-bottom: 2px solid transparent;
            transition: color 0.2s ease, border-color 0.2s ease;
        }

        .nav-link:hover {
            color: var(--light-grey);
        }

        .nav-link.active {
            font-weight: 700;
            border-bottom-color: var(--light-text);
        }

        main {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .user-bar {
            background-color: var(--light-grey);
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .user-info {
            font-weight: 600;
        }

        .user-semester {
            color: var(--grey-text);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .page-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .custom-dropdown {
            position: relative;
            user-select: none;
            min-width: 140px;
            touch-action: manipulation;
        }

        .dropdown-selected {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
            color: var(--light-text);
            padding: 0.875rem 1.25rem;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(210, 105, 30, 0.25);
            min-height: 44px;
            touch-action: manipulation;
        }
        
        .custom-dropdown.status-dropdown .dropdown-selected {
            border: none;
            color: var(--light-text);
        }

        .dropdown-selected:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(210, 105, 30, 0.35);
        }

        .dropdown-selected svg {
            width: 18px;
            height: 18px;
            transition: transform 0.3s ease;
        }

        .custom-dropdown.open .dropdown-selected svg {
            transform: rotate(180deg);
        }

        .dropdown-options {
            display: none;
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            overflow: hidden;
            z-index: 100;
            top: 110%;
            left: 0;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            animation: dropdownFade 0.2s ease;
        }

        @keyframes dropdownFade {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .custom-dropdown.open .dropdown-options {
            display: block;
        }

        .dropdown-option {
            padding: 0.875rem 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .dropdown-option:hover {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
            color: white;
        }

        .custom-date-picker {
            position: relative;
            min-width: 200px;
        }

        .date-picker-selected {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
            color: var(--light-text);
            padding: 0.875rem 1.25rem;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(210, 105, 30, 0.25);
        }

        .date-picker-selected:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(210, 105, 30, 0.35);
        }

        .date-picker-calendar {
            display: none;
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            z-index: 1001;
            top: 110%;
            left: 0;
            min-width: 280px;
            max-height: 350px;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            animation: dropdownFade 0.2s ease;
            padding: 1rem;
        }

        .custom-date-picker.open .date-picker-calendar {
            display: block;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .calendar-nav {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            font-family: 'Italiana', 'Inter', sans-serif;
            transition: background 0.2s ease;
        }

        .calendar-nav:hover {
            background: rgba(210, 105, 30, 0.1);
        }

        .calendar-month-year {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--grey-text);
            padding: 0.5rem;
        }

        .calendar-day {
            text-align: center;
            padding: 0.75rem 0.5rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .calendar-day:hover {
            background: rgba(210, 105, 30, 0.1);
        }

        .calendar-day.selected {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
            color: white;
        }

        .calendar-day.other-month {
            color: #ccc;
        }

        .calendar-day.today {
            background: rgba(210, 105, 30, 0.2);
            font-weight: 600;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-family: 'Italiana', 'Inter', sans-serif;
            color: var(--grey-text);
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-family: 'Italiana', 'Inter', sans-serif;
        }

        .auth-form {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status-present { background-color: var(--green); }
        .status-absent { background-color: var(--red); }
        .status-permission { background-color: var(--blue-accent); }
        .status-late { background-color: var(--yellow); color: var(--dark-text) !important; }

        .data-row {
            background-color: var(--light-grey);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            font-size: 1.1rem;
            font-weight: 500;
        }

        .subject-row-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .tick-btn {
            background-color: var(--green);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .tick-btn:hover {
            background-color: var(--green-dark);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        
        .tick-btn:disabled {
            background-color: #aaa;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .tick-btn svg {
            width: 24px;
            height: 24px;
        }

        .count-bubble {
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            color: var(--light-text);
            flex-shrink: 0;
        }
        
        .count-green { background-color: var(--green); }
        .count-red { background-color: var(--red); }
        .count-blue { background-color: var(--blue-accent); }
        .count-yellow { background-color: var(--yellow); color: var(--dark-text); }

        .total-header-row {
            display: flex;
            justify-content: flex-end;
            gap: 1.5rem;
            padding: 0 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .total-header-item {
            width: 44px;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--grey-text);
        }
        
        .total-subject-row .data-row-right {
            display: flex;
            gap: 1.5rem;
        }

        .settings-section {
            background-color: #fff;
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }

        .settings-header h3 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--light-text);
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            font-family: 'Italiana', 'Inter', sans-serif;
            transition: all 0.2s ease;
        }
        
        .btn-green {
            background-color: var(--green);
        }
        
        .btn-green:hover {
            background-color: var(--green-dark);
        }

        .btn-red {
            background-color: var(--red);
        }
        .btn-red:hover {
            background-color: var(--red-dark);
        }

        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Italiana', 'Inter', sans-serif;
        }
        
        .settings-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-radius: 8px;
            background-color: var(--bg-color);
            margin-bottom: 0.75rem;
        }
        
        .settings-list-item input {
            flex-grow: 1;
            margin-right: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
        }
        
        .settings-list-item .custom-dropdown {
            min-width: 150px;
            margin-right: 1rem;
        }
        
        .settings-list-item .btn-group {
            display: flex;
            gap: 0.5rem;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal-content {
            background: #fff;
            padding: 2rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h4 {
            font-size: 1.4rem;
        }
        
        .modal-close-btn {
            background: none;
            border: none;
            font-size: 1.75rem;
            cursor: pointer;
            color: var(--grey-text);
            font-family: 'Italiana', 'Inter', sans-serif;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .no-data-message {
            background-color: var(--light-grey);
            padding: 2rem;
            border-radius: var(--border-radius);
            text-align: center;
            color: var(--grey-text);
            font-weight: 500;
        }
        
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                padding: 1rem;
                gap: 1rem;
            }
            .app-nav {
                width: 100%;
                justify-content: space-around;
                gap: 0.5rem;
            }
            .nav-link {
                font-size: 0.85rem;
                padding: 0.5rem 0.25rem;
            }
            main {
                padding: 1rem 0.75rem;
            }
            .user-bar {
                flex-direction: column;
                gap: 0.5rem;
                padding: 1rem;
                font-size: 0.95rem;
                text-align: center;
            }
            
            .page-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .page-header h2 {
                font-size: 1.3rem;
                text-align: center;
            }
            
            .data-row {
                flex-direction: column;
                align-items: flex-start;
                padding: 1rem;
                gap: 1rem;
            }
            
            .subject-row-right {
                width: 100%;
                justify-content: space-between;
                gap: 1rem;
            }
            
            .custom-dropdown {
                flex-grow: 1;
                min-width: auto;
            }
            
            .dropdown-selected {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
            
            .tick-btn {
                width: 40px;
                height: 40px;
                flex-shrink: 0;
            }
            
            .count-bubble {
                width: 40px;
                height: 40px;
                font-size: 0.9rem;
            }
            
            .total-header-row {
                display: none;
            }
            
            .total-subject-row .data-row-right {
                width: 100%;
                justify-content: space-around;
                gap: 0.75rem;
            }
            
            .settings-section {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
            
            .settings-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .settings-list-item {
                flex-direction: column;
                gap: 0.75rem;
                align-items: stretch;
            }
            .settings-list-item input {
                margin-right: 0;
            }
            .settings-list-item .custom-dropdown {
                margin-right: 0;
            }
            .btn-group {
                justify-content: flex-end;
            }
            
            .modal-content {
                width: 95%;
                padding: 1.5rem;
                margin: 1rem;
            }
            
            .date-picker-calendar {
                min-width: 260px;
                max-height: 300px;
                left: 50%;
                transform: translateX(-50%);
            }
            
            .calendar-grid {
                gap: 2px;
            }
            
            .calendar-day {
                padding: 0.5rem 0.25rem;
                font-size: 0.9rem;
            }
            
            .form-input {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            #toast-message {
                bottom: 80px;
                left: 1rem;
                right: 1rem;
                transform: none;
                text-align: center;
            }
            
            .btn {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                min-height: 44px; /* Touch target size */
            }
        }
    </style>
</head>
<body>

    <header class="app-header">
        <h1>Attendance Tracker</h1>
        <nav class="app-nav">
            <a href="#" class="nav-link active" data-page="Home">Home</a>
            <a href="#" class="nav-link" data-page="WeeklyReport">Weekly Report</a>
            <a href="#" class="nav-link" data-page="Total">Total</a>
            <a href="#" class="nav-link" data-page="Settings">Settings</a>
        </nav>
    </header>

    <main>
        <div class="user-bar">
            <div>
                <span class="user-info" id="user-info-name">Hello, Lyssa</span><br>
                <span class="user-major" id="user-info-major">ITE</span>
            </div>
            <span class="user-semester" id="user-info-semester">Semester I, Year II</span>
        </div>

        <div class="page active" data-page="Home">
            <div class="page-header">
                <h2 id="home-day-title">Monday</h2>
                <h2>Daily Attendance</h2>
            </div>
            <div class="page-content" id="home-content">
            </div>
        </div>

        <div class="page" data-page="WeeklyReport">
            <div class="page-header">
                <div class="custom-dropdown" id="week-selector-dropdown">
                    <div class="dropdown-selected">
                        <span id="selected-week-display">Week 1</span>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                    </div>
                    <div class="dropdown-options" id="week-selector-options">
                    </div>
                </div>
                <h2>Weekly Report</h2>
            </div>
            <div class="page-content" id="weekly-report-content">
                <div class="data-row">
                    <span>Present</span>
                    <div class="count-bubble count-green" id="weekly-present">0</div>
                </div>
                <div class="data-row">
                    <span>Absent</span>
                    <div class="count-bubble count-red" id="weekly-absent">0</div>
                </div>
                <div class="data-row">
                    <span>Permission</span>
                    <div class="count-bubble count-blue" id="weekly-permission">0</div>
                </div>
                <div class="data-row">
                    <span>Late</span>
                    <div class="count-bubble count-yellow" id="weekly-late">0</div>
                </div>
                
                <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Warning</h3>
                <div class="no-data-message" id="weekly-warning">
                    No warning yet, keep up the good work!
                </div>
            </div>
        </div>

        <div class="page" data-page="Total">
            <div class="page-header">
                <h2>All Subjects</h2>
                <div class="total-header-row">
                    <span class="total-header-item">Present</span>
                    <span class="total-header-item">Absent</span>
                    <span class="total-header-item">Permit</span>
                    <span class="total-header-item">Late</span>
                </div>
            </div>
            <div class="page-content" id="total-content">
            </div>
        </div>

        <div class="page" data-page="Settings">
            <div class="settings-section">
                <div class="settings-header">
                    <h3>Profile</h3>
                    <div>
                        <button class="btn" id="auth-btn" style="margin-right: 0.5rem;">Sign In</button>
                        <button class="btn btn-red" id="signout-btn" style="display: none;">Sign Out</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="setting-name">Name</label>
                    <input type="text" id="setting-name" class="form-input" placeholder="Your Name" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="setting-major">Major</label>
                    <input type="text" id="setting-major" class="form-input" placeholder="Your Major" autocomplete="off">
                </div>
                <div id="auth-status" style="margin-bottom: 1rem; padding: 0.75rem; border-radius: 8px; font-size: 0.9rem;"></div>
                <button class="btn btn-green" id="save-profile-btn">Save Profile</button>
            </div>
            
            <div class="settings-section">
                <div class="settings-header">
                    <h3>Manage Semesters</h3>
                    <button class="btn btn-green" id="add-semester-btn">Add Semester</button>
                </div>
                <div class="form-group">
                    <label for="setting-current-semester">Current Semester</label>
                    <div class="custom-dropdown" id="current-semester-dropdown">
                        <div class="dropdown-selected">
                            <span id="current-semester-display">Select a semester...</span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                        </div>
                        <div class="dropdown-options" id="current-semester-options">
                        </div>
                    </div>
                </div>
                <div id="semesters-list">
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-header">
                    <h3>Manage Subjects</h3>
                    <button class="btn btn-green" id="add-subject-btn">Add Subject</button>
                </div>
                <p style="margin-bottom: 1rem; color: var(--grey-text);">Subjects for current semester:</p>
                <div id="subjects-list">
                </div>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="subject-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="subject-modal-title">Add Subject</h4>
                <button class="modal-close-btn" data-modal-close="subject-modal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="subject-modal-id">
                <div class="form-group">
                    <label for="subject-modal-name">Subject Name</label>
                    <input type="text" id="subject-modal-name" class="form-input" placeholder="e.g., Mathematics" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="subject-modal-day">Day of Week</label>
                    <div class="custom-dropdown" id="subject-modal-day-dropdown">
                        <div class="dropdown-selected">
                            <span id="subject-modal-day-display">Select a day...</span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                        </div>
                        <div class="dropdown-options">
                            <div class="dropdown-option" data-value="Sunday">Sunday</div>
                            <div class="dropdown-option" data-value="Monday">Monday</div>
                            <div class="dropdown-option" data-value="Tuesday">Tuesday</div>
                            <div class="dropdown-option" data-value="Wednesday">Wednesday</div>
                            <div class="dropdown-option" data-value="Thursday">Thursday</div>
                            <div class="dropdown-option" data-value="Friday">Friday</div>
                            <div class="dropdown-option" data-value="Saturday">Saturday</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" data-modal-close="subject-modal">Cancel</button>
                <button class="btn btn-green" id="save-subject-btn">Save Subject</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="semester-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="semester-modal-title">Add Semester</h4>
                <button class="modal-close-btn" data-modal-close="semester-modal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="semester-modal-id">
                <div class="form-group">
                    <label for="semester-modal-name">Semester Name</label>
                    <input type="text" id="semester-modal-name" class="form-input" placeholder="e.g., Year 1, Semester I" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="semester-modal-start-date">Start Date</label>
                    <div class="custom-date-picker" id="semester-start-date-picker">
                        <div class="date-picker-selected">
                            <span id="semester-start-date-display">Select start date</span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 18px; height: 18px;"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5a2.25 2.25 0 002.25-2.25m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5a2.25 2.25 0 012.25 2.25v7.5" /></svg>
                        </div>
                        <div class="date-picker-calendar">
                            <div class="calendar-header">
                                <button class="calendar-nav" id="start-prev-month">‹</button>
                                <div class="calendar-month-year" id="start-month-year"></div>
                                <button class="calendar-nav" id="start-next-month">›</button>
                            </div>
                            <div class="calendar-grid" id="start-calendar-grid"></div>
                        </div>
                    </div>
                    <input type="hidden" id="semester-modal-start-date">
                </div>
                <div class="form-group">
                    <label for="semester-modal-end-date">End Date</label>
                    <div class="custom-date-picker" id="semester-end-date-picker">
                        <div class="date-picker-selected">
                            <span id="semester-end-date-display">Select end date</span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 18px; height: 18px;"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5a2.25 2.25 0 002.25-2.25m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5a2.25 2.25 0 012.25 2.25v7.5" /></svg>
                        </div>
                        <div class="date-picker-calendar">
                            <div class="calendar-header">
                                <button class="calendar-nav" id="end-prev-month">‹</button>
                                <div class="calendar-month-year" id="end-month-year"></div>
                                <button class="calendar-nav" id="end-next-month">›</button>
                            </div>
                            <div class="calendar-grid" id="end-calendar-grid"></div>
                        </div>
                    </div>
                    <input type="hidden" id="semester-modal-end-date">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" data-modal-close="semester-modal">Cancel</button>
                <button class="btn btn-green" id="save-semester-btn">Save Semester</button>
            </div>
        </div>
    </div>
    
    <div id="toast-message" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 1rem 2rem; border-radius: 8px; z-index: 2000; font-weight: 500;">
        Message
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="auth-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="auth-modal-title">Sign In</h4>
                <button class="modal-close-btn" data-modal-close="auth-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="signin">Sign In</button>
                    <button class="auth-tab" data-tab="signup">Sign Up</button>
                </div>
                
                <div class="auth-form" id="signin-form">
                    <div class="form-group">
                        <label for="signin-email">Email</label>
                        <input type="email" id="signin-email" class="form-input" placeholder="your@email.com" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="signin-password">Password</label>
                        <input type="password" id="signin-password" class="form-input" placeholder="Password" autocomplete="off">
                    </div>
                    <button class="btn btn-green" id="signin-btn" style="width: 100%; margin-top: 1rem;">Sign In</button>
                </div>
                
                <div class="auth-form" id="signup-form" style="display: none;">
                    <div class="form-group">
                        <label for="signup-email">Email</label>
                        <input type="email" id="signup-email" class="form-input" placeholder="your@email.com" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Password</label>
                        <input type="password" id="signup-password" class="form-input" placeholder="Password (min 6 characters)" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="signup-name">Name</label>
                        <input type="text" id="signup-name" class="form-input" placeholder="Your Name" autocomplete="off">
                    </div>
                    <button class="btn btn-green" id="signup-btn" style="width: 100%; margin-top: 1rem;">Create Account</button>
                </div>
                
                <div style="text-align: center; margin: 1.5rem 0; color: var(--grey-text);">or</div>
                
                <button class="btn" id="continue-anonymous-btn" style="width: 100%; background: var(--light-grey); color: var(--dark-text);">Continue Without Account</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            addDoc,
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth;
        let userId = null;
        let currentSemesterId = null;
        let userProfile = {};
        let allSemesters = [];
        let allSubjects = [];
        let allAttendance = [];
        let currentPage = 'Home';
        let isAnonymous = false;

        const appId = 'attendance-tracker-app';
        const firebaseConfig = {
            apiKey: import.meta.env.VITE_FIREBASE_API_KEY || process.env.REACT_APP_FIREBASE_API_KEY || "YOUR_API_KEY_HERE",
            authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN || process.env.REACT_APP_FIREBASE_AUTH_DOMAIN || "your-project.firebaseapp.com",
            projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID || process.env.REACT_APP_FIREBASE_PROJECT_ID || "your-project-id",
            storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET || process.env.REACT_APP_FIREBASE_STORAGE_BUCKET || "your-project.firebasestorage.app",
            messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID || process.env.REACT_APP_FIREBASE_MESSAGING_SENDER_ID || "YOUR_SENDER_ID",
            appId: import.meta.env.VITE_FIREBASE_APP_ID || process.env.REACT_APP_FIREBASE_APP_ID || "YOUR_APP_ID",
            measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID || process.env.REACT_APP_FIREBASE_MEASUREMENT_ID || "YOUR_MEASUREMENT_ID"
        };

        const paths = {
            userProfile: () => `artifacts/${appId}/users/${userId}/profile/details`,
            semesters: () => `artifacts/${appId}/users/${userId}/semesters`,
            semesterDoc: (id) => `artifacts/${appId}/users/${userId}/semesters/${id}`,
            subjects: () => `artifacts/${appId}/users/${userId}/subjects`,
            subjectDoc: (id) => `artifacts/${appId}/users/${userId}/subjects/${id}`,
            attendance: () => `artifacts/${appId}/users/${userId}/attendanceRecords`,
        };

        const DAYS_OF_WEEK = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        
        function getTodayDateString() {
            return new Date().toISOString().split('T')[0];
        }
        
        function getCurrentDayName() {
            return DAYS_OF_WEEK[new Date().getDay()];
        }
        
        function getSemesterWeek(dateString, semester) {
            if (!semester || !semester.startDate) {
                return null;
            }
            try {
                const start = new Date(semester.startDate);
                const today = new Date(dateString);

                start.setHours(0, 0, 0, 0);
                today.setHours(0, 0, 0, 0);

                // Convert Sunday=0 to Monday=0 system
                const startDayOfWeek = (start.getDay() + 6) % 7; // Monday=0, Sunday=6
                const startDateOfWeek = new Date(start.getTime() - startDayOfWeek * 24 * 60 * 60 * 1000);

                const diffTime = today.getTime() - startDateOfWeek.getTime();
                if (diffTime < 0) {
                    return null;
                }
                
                const diffDays = diffTime / (1000 * 60 * 60 * 24);
                const weekNumber = Math.floor(diffDays / 7) + 1;
                
                return weekNumber;
            } catch (e) {
                console.error("Error calculating semester week:", e);
                return null;
            }
        }

        function calculateWarning(late, permission, absent) {
            // Calculate warning score using TOTAL semester counts (not weekly)
            // Formula: absent + (permission + floor(late/3))
            const score = absent + (permission + Math.floor(late / 3));
            
            if (absent > 2 || score > 4) {
                return { status: 'RED ERROR WARNING', color: 'var(--red)' };
            } else if (score <= 2) {
                return { status: 'Good', color: 'var(--green)' };
            } else if (score === 3) {
                return { status: 'FIRST WARNING', color: 'var(--yellow-dark)' };
            } else if (score === 4) {
                return { status: 'LAST WARNING', color: 'var(--red)' };
            }
            return { status: '', color: 'var(--grey-text)' };
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast-message');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, duration);
        }

        function initializeCustomDropdowns() {
            document.body.addEventListener('click', (e) => {
                if (!e.target.closest('.custom-dropdown') && !e.target.closest('.custom-date-picker')) {
                    document.querySelectorAll('.custom-dropdown.open').forEach(dropdown => {
                        dropdown.classList.remove('open');
                    });
                    document.querySelectorAll('.custom-date-picker.open').forEach(picker => {
                        picker.classList.remove('open');
                    });
                }
                
                const selected = e.target.closest('.dropdown-selected');
                if (selected) {
                    const dropdown = selected.closest('.custom-dropdown');
                    dropdown.classList.toggle('open');
                }
                
                const dateSelected = e.target.closest('.date-picker-selected');
                if (dateSelected) {
                    const picker = dateSelected.closest('.custom-date-picker');
                    
                    // Close all other date pickers first
                    document.querySelectorAll('.custom-date-picker.open').forEach(otherPicker => {
                        if (otherPicker !== picker) {
                            otherPicker.classList.remove('open');
                        }
                    });
                    
                    // Toggle the clicked one
                    picker.classList.toggle('open');
                }
                
                const option = e.target.closest('.dropdown-option');
                if (option) {
                    const dropdown = option.closest('.custom-dropdown');
                    const selectedDisplay = dropdown.querySelector('.dropdown-selected span');
                    const value = option.dataset.value;
                    
                    selectedDisplay.textContent = option.textContent;
                    dropdown.dataset.value = value;
                    dropdown.classList.remove('open');
                    
                    if (dropdown.classList.contains('status-dropdown')) {
                        const selectedBox = dropdown.querySelector('.dropdown-selected');
                        selectedBox.className = 'dropdown-selected';
                        selectedBox.classList.add(`status-${value.toLowerCase()}`);
                    }
                    
                    dropdown.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
        }

        function initializeDatePickers() {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const dayHeaders = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];

            function createDatePicker(pickerId, displayId, hiddenInputId, monthYearId, gridId, prevBtnId, nextBtnId) {
                let currentDate = new Date();
                let selectedDate = null;

                function renderCalendar() {
                    const monthYear = document.getElementById(monthYearId);
                    const grid = document.getElementById(gridId);
                    
                    monthYear.textContent = `${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
                    
                    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                    const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                    const startDate = new Date(firstDay);
                    startDate.setDate(startDate.getDate() - firstDay.getDay());
                    
                    grid.innerHTML = '';
                    
                    dayHeaders.forEach(day => {
                        const dayHeader = document.createElement('div');
                        dayHeader.className = 'calendar-day-header';
                        dayHeader.textContent = day;
                        grid.appendChild(dayHeader);
                    });
                    
                    for (let i = 0; i < 42; i++) {
                        const date = new Date(startDate);
                        date.setDate(startDate.getDate() + i);
                        
                        const dayElement = document.createElement('div');
                        dayElement.className = 'calendar-day';
                        dayElement.textContent = date.getDate();
                        
                        if (date.getMonth() !== currentDate.getMonth()) {
                            dayElement.classList.add('other-month');
                        }
                        
                        if (date.toDateString() === new Date().toDateString()) {
                            dayElement.classList.add('today');
                        }
                        
                        if (selectedDate && date.toDateString() === selectedDate.toDateString()) {
                            dayElement.classList.add('selected');
                        }
                        
                        dayElement.addEventListener('click', () => {
                            selectedDate = new Date(date);
                            const display = document.getElementById(displayId);
                            const hiddenInput = document.getElementById(hiddenInputId);
                            
                            display.textContent = selectedDate.toLocaleDateString('en-US', { 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            });
                            hiddenInput.value = selectedDate.toISOString().split('T')[0];
                            
                            document.getElementById(pickerId).classList.remove('open');
                        });
                        
                        grid.appendChild(dayElement);
                    }
                }
                
                document.getElementById(prevBtnId).addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar();
                });
                
                document.getElementById(nextBtnId).addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar();
                });
                
                renderCalendar();
            }

            createDatePicker(
                'semester-start-date-picker',
                'semester-start-date-display', 
                'semester-modal-start-date',
                'start-month-year',
                'start-calendar-grid',
                'start-prev-month',
                'start-next-month'
            );

            createDatePicker(
                'semester-end-date-picker',
                'semester-end-date-display',
                'semester-modal-end-date', 
                'end-month-year',
                'end-calendar-grid',
                'end-prev-month',
                'end-next-month'
            );
        }
        
        function initializeModals() {
            document.body.addEventListener('click', (e) => {
                const modalClose = e.target.closest('[data-modal-close]');
                if (modalClose) {
                    const modalId = modalClose.dataset.modalClose;
                    document.getElementById(modalId).classList.remove('show');
                }
            });
            
            document.getElementById('add-subject-btn').addEventListener('click', () => openSubjectModal());
            document.getElementById('add-semester-btn').addEventListener('click', () => openSemesterModal());
            
            document.getElementById('save-subject-btn').addEventListener('click', handleSaveSubject);
            document.getElementById('save-semester-btn').addEventListener('click', handleSaveSemester);
        }

        function initializeAuth() {
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const tabType = e.target.dataset.tab;
                    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    document.getElementById('signin-form').style.display = tabType === 'signin' ? 'block' : 'none';
                    document.getElementById('signup-form').style.display = tabType === 'signup' ? 'block' : 'none';
                    document.getElementById('auth-modal-title').textContent = tabType === 'signin' ? 'Sign In' : 'Sign Up';
                });
            });
            
            document.getElementById('auth-btn').addEventListener('click', () => openModal('auth-modal'));
            document.getElementById('signout-btn').addEventListener('click', handleSignOut);
            document.getElementById('signin-btn').addEventListener('click', handleSignIn);
            document.getElementById('signup-btn').addEventListener('click', handleSignUp);
            document.getElementById('continue-anonymous-btn').addEventListener('click', handleContinueAnonymous);
        }

        async function handleSignIn() {
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            
            if (!email || !password) {
                showToast('Please fill in all fields');
                return;
            }
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeModal('auth-modal');
                showToast('Signed in successfully!');
            } catch (error) {
                showToast('Sign in failed: ' + error.message);
            }
        }

        async function handleSignUp() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const name = document.getElementById('signup-name').value;
            
            if (!email || !password || !name) {
                showToast('Please fill in all fields');
                return;
            }
            
            if (password.length < 6) {
                showToast('Password must be at least 6 characters');
                return;
            }
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, paths.userProfile()), { name, major: '' }, { merge: true });
                closeModal('auth-modal');
                showToast('Account created successfully!');
            } catch (error) {
                showToast('Sign up failed: ' + error.message);
            }
        }

        async function handleContinueAnonymous() {
            try {
                await signInAnonymously(auth);
                closeModal('auth-modal');
            } catch (error) {
                showToast('Error: ' + error.message);
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
                showToast('Signed out successfully');
            } catch (error) {
                showToast('Sign out failed: ' + error.message);
            }
        }

        function updateAuthUI(user) {
            const authBtn = document.getElementById('auth-btn');
            const signoutBtn = document.getElementById('signout-btn');
            const authStatus = document.getElementById('auth-status');
            
            if (user) {
                isAnonymous = user.isAnonymous;
                
                if (user.isAnonymous) {
                    authBtn.textContent = 'Create Account';
                    authBtn.style.display = 'inline-block';
                    signoutBtn.style.display = 'none';
                    authStatus.innerHTML = '<div style="background: var(--yellow); color: var(--dark-text); padding: 0.5rem; border-radius: 6px;">⚠️ Using temporary account - data may be lost</div>';
                } else {
                    authBtn.style.display = 'none';
                    signoutBtn.style.display = 'inline-block';
                    authStatus.innerHTML = `<div style="background: var(--green); color: white; padding: 0.5rem; border-radius: 6px;">✓ Signed in as ${user.email}</div>`;
                }
            } else {
                authBtn.textContent = 'Sign In';
                authBtn.style.display = 'inline-block';
                signoutBtn.style.display = 'none';
                authStatus.innerHTML = '<div style="background: var(--red); color: white; padding: 0.5rem; border-radius: 6px;">Not signed in</div>';
            }
        }
        
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }
        
        function openSubjectModal(subject = null) {
            const modal = document.getElementById('subject-modal');
            const title = modal.querySelector('#subject-modal-title');
            const idInput = modal.querySelector('#subject-modal-id');
            const nameInput = modal.querySelector('#subject-modal-name');
            const dayDropdown = modal.querySelector('#subject-modal-day-dropdown');
            const dayDisplay = modal.querySelector('#subject-modal-day-display');

            if (subject) {
                title.textContent = 'Edit Subject';
                idInput.value = subject.id;
                nameInput.value = subject.name;
                dayDisplay.textContent = subject.day;
                dayDropdown.dataset.value = subject.day;
            } else {
                title.textContent = 'Add Subject';
                idInput.value = '';
                nameInput.value = '';
                dayDisplay.textContent = 'Select a day...';
                dayDropdown.dataset.value = '';
            }
            openModal('subject-modal');
        }
        
        function openSemesterModal(semester = null) {
            const modal = document.getElementById('semester-modal');
            const title = modal.querySelector('#semester-modal-title');
            const idInput = modal.querySelector('#semester-modal-id');
            const nameInput = modal.querySelector('#semester-modal-name');
            const startDateInput = modal.querySelector('#semester-modal-start-date');
            const endDateInput = modal.querySelector('#semester-modal-end-date');

            if (semester) {
                title.textContent = 'Edit Semester';
                idInput.value = semester.id;
                nameInput.value = semester.name;
                startDateInput.value = semester.startDate || '';
                endDateInput.value = semester.endDate || '';
            } else {
                title.textContent = 'Add Semester';
                idInput.value = '';
                nameInput.value = '';
                startDateInput.value = '';
                endDateInput.value = '';
            }
            openModal('semester-modal');
        }

        function initializeNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = link.dataset.page;
                    navigateTo(page);
                });
            });
        }
        
        function navigateTo(pageName) {
            currentPage = pageName;
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.page === pageName);
            });
            
            document.querySelectorAll('.page').forEach(page => {
                page.classList.toggle('active', page.dataset.page === pageName);
            });
            
            renderCurrentPage();
        }
        
        function renderCurrentPage() {
            if (!userId) return;
            
            renderHeader();
            
            switch (currentPage) {
                case 'Home':
                    renderHomePage();
                    break;
                case 'WeeklyReport':
                    renderWeeklyReportPage();
                    break;
                case 'Total':
                    renderTotalPage();
                    break;
                case 'Settings':
                    renderSettingsPage();
                    break;
            }
        }
        
        function renderHeader() {
            if (userProfile.name) {
                document.getElementById('user-info-name').textContent = `Hello, ${userProfile.name}`;
            }
            if (userProfile.major) {
                document.getElementById('user-info-major').textContent = userProfile.major;
            }
            
            const currentSem = allSemesters.find(s => s.id === currentSemesterId);
            if (currentSem) {
                document.getElementById('user-info-semester').textContent = currentSem.name;
            } else {
                document.getElementById('user-info-semester').textContent = "No semester selected";
            }
        }

        function renderHomePage() {
            const container = document.getElementById('home-content');
            const today = getCurrentDayName();
            const todayDate = getTodayDateString();
            
            document.getElementById('home-day-title').textContent = today;
            
            const subjectsToday = allSubjects.filter(s => s.day === today && s.semesterId === currentSemesterId);
            const attendanceToday = allAttendance.filter(r => r.date === todayDate);

            if (subjectsToday.length === 0) {
                container.innerHTML = `<div class="no-data-message">No subjects scheduled for today.</div>`;
                return;
            }
            
            container.innerHTML = subjectsToday.map(subject => {
                const record = attendanceToday.find(r => r.subjectId === subject.id);
                const status = record ? record.status : "Select";
                const statusClass = record ? `status-${status.toLowerCase()}` : "status-present";
                const isDisabled = !!record;
                
                return `
                <div class="data-row" id="subject-row-${subject.id}">
                    <span>${subject.name}</span>
                    <div class="subject-row-right">
                        <div class="custom-dropdown status-dropdown" data-value="${status}" data-subject-id="${subject.id}">
                            <div class="dropdown-selected ${statusClass}">
                                <span>${status}</span>
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                            </div>
                            <div class="dropdown-options">
                                <div class="dropdown-option" data-value="Present">Present</div>
                                <div class="dropdown-option" data-value="Absent">Absent</div>
                                <div class="dropdown-option" data-value="Permission">Permission</div>
                                <div class="dropdown-option" data-value="Late">Late</div>
                            </div>
                        </div>
                        <button class="tick-btn" data-subject-id="${subject.id}" title="Submit Attendance" ${isDisabled ? 'disabled' : ''}>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>
                        </button>
                    </div>
                </div>
                `;
            }).join('');
            
            container.querySelectorAll('.tick-btn').forEach(btn => {
                btn.addEventListener('click', handleSubmitAttendance);
            });
        }
        
        async function handleSubmitAttendance(e) {
            const btn = e.currentTarget;
            const subjectId = btn.dataset.subjectId;
            const dropdown = document.querySelector(`.custom-dropdown[data-subject-id="${subjectId}"]`);
            const status = dropdown.dataset.value;
            
            if (status === 'Select') {
                showToast('Please select a status first.');
                return;
            }
            
            const todayDate = getTodayDateString();
            const currentSem = allSemesters.find(s => s.id === currentSemesterId);
            const semesterWeek = getSemesterWeek(todayDate, currentSem);
            
            const record = {
                subjectId: subjectId,
                semesterId: currentSemesterId,
                date: todayDate,
                status: status,
                semesterWeek: semesterWeek,
                createdAt: serverTimestamp()
            };
            
            try {
                btn.disabled = true;
                await addDoc(collection(db, paths.attendance()), record);
                showToast('Attendance saved!');
            } catch (error) {
                console.error("Error saving attendance: ", error);
                showToast('Error saving attendance.');
                btn.disabled = false;
            }
        }

        function renderWeeklyReportPage() {
            const currentSemAttendance = allAttendance.filter(r => r.semesterId === currentSemesterId);
            const currentSem = allSemesters.find(s => s.id === currentSemesterId);
            
            const uniqueWeeks = [...new Set(currentSemAttendance.map(r => r.semesterWeek))];
            const validWeeks = uniqueWeeks.filter(w => w != null).sort((a, b) => b - a);
            
            const weekOptionsContainer = document.getElementById('week-selector-options');
            if (validWeeks.length > 0) {
                weekOptionsContainer.innerHTML = validWeeks.map(week => {
                    return `<div class="dropdown-option" data-value="${week}">Week ${week}</div>`;
                }).join('');
            } else {
                weekOptionsContainer.innerHTML = `<div class="dropdown-option" data-value="">No data</div>`;
            }
            
            const currentSemesterWeek = getSemesterWeek(getTodayDateString(), currentSem);
            
            const weekDropdown = document.getElementById('week-selector-dropdown');
            const selectedWeekDisplay = document.getElementById('selected-week-display');
            
            let weekToDisplay = currentSemesterWeek;
            if (currentSemesterWeek && validWeeks.includes(currentSemesterWeek)) {
                weekDropdown.dataset.value = currentSemesterWeek;
                selectedWeekDisplay.textContent = `Week ${currentSemesterWeek}`;
            } else if (validWeeks.length > 0) {
                weekToDisplay = validWeeks[0];
                weekDropdown.dataset.value = weekToDisplay;
                selectedWeekDisplay.textContent = `Week ${weekToDisplay}`;
            } else {
                weekDropdown.dataset.value = currentSemesterWeek || 1;
                selectedWeekDisplay.textContent = `Week ${currentSemesterWeek || 1}`;
            }

            const selectedWeek = parseInt(weekDropdown.dataset.value, 10);
            const weeklyData = currentSemAttendance.filter(r => r.semesterWeek === selectedWeek);
            
            const counts = {
                Present: 0,
                Absent: 0,
                Permission: 0,
                Late: 0
            };
            
            weeklyData.forEach(r => {
                if (counts.hasOwnProperty(r.status)) {
                    counts[r.status]++;
                }
            });
            
            document.getElementById('weekly-present').textContent = counts.Present;
            document.getElementById('weekly-absent').textContent = counts.Absent;
            document.getElementById('weekly-permission').textContent = counts.Permission;
            document.getElementById('weekly-late').textContent = counts.Late;
            
            // Calculate semester totals for warning system
            const semesterTotals = {
                Present: 0,
                Absent: 0,
                Permission: 0,
                Late: 0
            };
            
            currentSemAttendance.forEach(r => {
                if (semesterTotals.hasOwnProperty(r.status)) {
                    semesterTotals[r.status]++;
                }
            });
            
            const warning = calculateWarning(semesterTotals.Late, semesterTotals.Permission, semesterTotals.Absent);
            const warningEl = document.getElementById('weekly-warning');
            warningEl.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 0.5rem;">Semester Status:</div>
                <div style="color: ${warning.color}; font-weight: 500;">${warning.status}</div>
                <div style="font-size: 0.9rem; color: var(--grey-text); margin-top: 0.5rem;">
                    Total: ${semesterTotals.Absent} absent, ${semesterTotals.Permission} permission, ${semesterTotals.Late} late
                </div>
            `;
        }
        
        document.getElementById('week-selector-dropdown').addEventListener('change', renderWeeklyReportPage);

        function renderTotalPage() {
            const container = document.getElementById('total-content');
            const currentSemSubjects = allSubjects.filter(s => s.semesterId === currentSemesterId);
            const currentSemAttendance = allAttendance.filter(r => r.semesterId === currentSemesterId);
            
            if (currentSemSubjects.length === 0) {
                container.innerHTML = `<div class="no-data-message">No subjects found for this semester.</div>`;
                return;
            }
            
            container.innerHTML = currentSemSubjects.map(subject => {
                // Get ALL attendance records for this subject across the ENTIRE semester
                const subjectAttendance = currentSemAttendance.filter(r => r.subjectId === subject.id);
                
                // Count TOTAL occurrences across all weeks in the semester
                const counts = {
                    Present: 0,
                    Absent: 0,
                    Permission: 0,
                    Late: 0
                };
                
                subjectAttendance.forEach(r => {
                    if (counts.hasOwnProperty(r.status)) {
                        counts[r.status]++;
                    }
                });
                
                // Calculate warning based on SEMESTER TOTALS
                const warning = calculateWarning(counts.Late, counts.Permission, counts.Absent);
                
                return `
                <div class="total-subject-row">
                    <div class="data-row">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">${subject.name}</div>
                            <div style="font-size: 0.9rem; color: ${warning.color}; font-weight: 500;">${warning.status}</div>
                        </div>
                        <div class="data-row-right">
                            <div class="count-bubble count-green">${counts.Present}</div>
                            <div class="count-bubble count-red">${counts.Absent}</div>
                            <div class="count-bubble count-blue">${counts.Permission}</div>
                            <div class="count-bubble count-yellow">${counts.Late}</div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderSettingsPage() {
            document.getElementById('setting-name').value = userProfile.name || '';
            document.getElementById('setting-major').value = userProfile.major || '';
            
            const semesterOptionsContainer = document.getElementById('current-semester-options');
            const semesterListContainer = document.getElementById('semesters-list');
            const currentSemesterDisplay = document.getElementById('current-semester-display');
            
            if (allSemesters.length > 0) {
                semesterOptionsContainer.innerHTML = allSemesters.map(s => 
                    `<div class="dropdown-option" data-value="${s.id}">${s.name}</div>`
                ).join('');
                
                semesterListContainer.innerHTML = allSemesters.map(s => `
                    <div class="settings-list-item" data-id="${s.id}">
                        <div>
                            <strong>${s.name}</strong><br>
                            <small style="color: var(--grey-text);">${s.startDate || 'No start date'} to ${s.endDate || 'No end date'}</small>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-edit-semester">Edit</button>
                            <button class="btn btn-red btn-delete-semester">Delete</button>
                        </div>
                    </div>
                `).join('');
                
                const currentSem = allSemesters.find(s => s.id === currentSemesterId);
                if (currentSem) {
                    currentSemesterDisplay.textContent = currentSem.name;
                    document.getElementById('current-semester-dropdown').dataset.value = currentSem.id;
                } else {
                    currentSemesterDisplay.textContent = 'Select a semester...';
                }
                
            } else {
                semesterOptionsContainer.innerHTML = `<div class="dropdown-option">No semesters</div>`;
                semesterListContainer.innerHTML = `<div class="no-data-message">No semesters added yet.</div>`;
                currentSemesterDisplay.textContent = 'Add a semester...';
            }
            
            const subjectsListContainer = document.getElementById('subjects-list');
            const currentSemSubjects = allSubjects.filter(s => s.semesterId === currentSemesterId);
            
            if (currentSemSubjects.length > 0) {
                subjectsListContainer.innerHTML = currentSemSubjects.map(s => `
                    <div class="settings-list-item" data-id="${s.id}">
                        <span><strong>${s.name}</strong> (${s.day})</span>
                        <div class="btn-group">
                            <button class="btn btn-edit-subject">Edit</button>
                            <button class="btn btn-red btn-delete-subject">Delete</button>
                        </div>
                    </div>
                `).join('');
            } else {
                subjectsListContainer.innerHTML = `<div class="no-data-message">No subjects added for this semester.</div>`;
            }
            
            addSettingsEventListeners();
        }
        
        function addSettingsEventListeners() {
            document.getElementById('save-profile-btn').removeEventListener('click', handleSaveProfile);
            document.getElementById('current-semester-dropdown').removeEventListener('change', handleCurrentSemesterChange);
            
            document.getElementById('save-profile-btn').addEventListener('click', handleSaveProfile);
            document.getElementById('current-semester-dropdown').addEventListener('change', handleCurrentSemesterChange);
            
            document.querySelectorAll('.btn-edit-semester').forEach(btn => btn.addEventListener('click', (e) => {
                const id = e.target.closest('.settings-list-item').dataset.id;
                const semester = allSemesters.find(s => s.id === id);
                openSemesterModal(semester);
            }));
            
            document.querySelectorAll('.btn-delete-semester').forEach(btn => btn.addEventListener('click', (e) => {
                const id = e.target.closest('.settings-list-item').dataset.id;
                handleDeleteSemester(id);
            }));
            
            document.querySelectorAll('.btn-edit-subject').forEach(btn => btn.addEventListener('click', (e) => {
                const id = e.target.closest('.settings-list-item').dataset.id;
                const subject = allSubjects.find(s => s.id === id);
                openSubjectModal(subject);
            }));
            
            document.querySelectorAll('.btn-delete-subject').forEach(btn => btn.addEventListener('click', (e) => {
                const id = e.target.closest('.settings-list-item').dataset.id;
                handleDeleteSubject(id);
            }));
        }
        
        async function handleSaveProfile() {
            const name = document.getElementById('setting-name').value;
            const major = document.getElementById('setting-major').value;
            try {
                await setDoc(doc(db, paths.userProfile()), { name, major }, { merge: true });
                showToast('Profile saved!');
            } catch (error) {
                console.error("Error saving profile: ", error);
                showToast('Error saving profile.');
            }
        }
        
        async function handleCurrentSemesterChange(e) {
            const newSemesterId = e.currentTarget.dataset.value;
            try {
                await setDoc(doc(db, paths.userProfile()), { currentSemesterId: newSemesterId }, { merge: true });
                showToast('Current semester updated!');
            } catch (error) {
                console.error("Error updating current semester: ", error);
                showToast('Error updating semester.');
            }
        }
        
        async function handleSaveSemester() {
            const id = document.getElementById('semester-modal-id').value;
            const name = document.getElementById('semester-modal-name').value;
            const startDate = document.getElementById('semester-modal-start-date').value;
            const endDate = document.getElementById('semester-modal-end-date').value;
            
            if (!name || !startDate || !endDate) {
                showToast('Please enter a name, start date, and end date.');
                return;
            }
            
            const semesterData = { name, startDate, endDate };
            
            try {
                if (id) {
                    await setDoc(doc(db, paths.semesterDoc(id)), semesterData, { merge: true });
                } else {
                    await addDoc(collection(db, paths.semesters()), semesterData);
                }
                showToast('Semester saved!');
                closeModal('semester-modal');
            } catch (error) {
                console.error("Error saving semester: ", error);
                showToast('Error saving semester.');
            }
        }
        
        async function handleDeleteSemester(id) {
            try {
                await deleteDoc(doc(db, paths.semesterDoc(id)));
                showToast('Semester deleted.');
            } catch (error) {
                console.error("Error deleting semester: ", error);
                showToast('Error deleting semester.');
            }
        }
        
        async function handleSaveSubject() {
            const id = document.getElementById('subject-modal-id').value;
            const name = document.getElementById('subject-modal-name').value;
            const day = document.getElementById('subject-modal-day-dropdown').dataset.value;
            
            if (!name || !day || !currentSemesterId) {
                showToast('Please fill all fields and select a semester.');
                return;
            }
            
            const subjectData = {
                name,
                day,
                semesterId: currentSemesterId
            };
            
            try {
                if (id) {
                    await setDoc(doc(db, paths.subjectDoc(id)), subjectData, { merge: true });
                } else {
                    await addDoc(collection(db, paths.subjects()), subjectData);
                }
                showToast('Subject saved!');
                closeModal('subject-modal');
            } catch (error) {
                console.error("Error saving subject: ", error);
                showToast('Error saving subject.');
            }
        }
        
        async function handleDeleteSubject(id) {
            try {
                await deleteDoc(doc(db, paths.subjectDoc(id)));
                showToast('Subject deleted.');
            } catch (error) {
                console.error("Error deleting subject: ", error);
                showToast('Error deleting subject.');
            }
        }
        
        function loadUserProfile() {
            onSnapshot(doc(db, paths.userProfile()), (docSnap) => {
                if (docSnap.exists()) {
                    userProfile = docSnap.data();
                    currentSemesterId = userProfile.currentSemesterId || null;
                } else {
                    setDoc(doc(db, paths.userProfile()), {
                        name: "New User",
                        major: "Your Major",
                        currentSemesterId: null
                    }, { merge: true });
                }
                renderCurrentPage();
            }, (error) => console.error("Error loading profile:", error));
        }
        
        function loadSemesters() {
            onSnapshot(collection(db, paths.semesters()), (snapshot) => {
                allSemesters = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCurrentPage();
            }, (error) => console.error("Error loading semesters:", error));
        }
        
        function loadSubjects() {
            onSnapshot(collection(db, paths.subjects()), (snapshot) => {
                allSubjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCurrentPage();
            }, (error) => console.error("Error loading subjects:", error));
        }
        
        function loadAttendance() {
            onSnapshot(collection(db, paths.attendance()), (snapshot) => {
                allAttendance = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCurrentPage();
            }, (error) => console.error("Error loading attendance:", error));
        }
        
        async function handleAuth() {
            auth = getAuth();
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("User is authenticated:", user.uid);
                    userId = user.uid;
                    updateAuthUI(user);
                    
                    loadUserProfile();
                    loadSemesters();
                    loadSubjects();
                    loadAttendance();
                    
                    navigateTo('Home');
                } else {
                    console.log("User not authenticated");
                    updateAuthUI(null);
                    openModal('auth-modal');
                }
            });
        }

        function initApp() {
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey === '<your-api-key>') {
                document.body.innerHTML = "<h1>Error: Firebase config is missing or invalid.</h1>";
                console.error("Firebase config is missing or invalid.");
                return;
            }
            
            setLogLevel('debug');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            
            initializeNavigation();
            initializeCustomDropdowns();
            initializeDatePickers();
            initializeModals();
            initializeAuth();
            handleAuth();
        }

        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>