<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Tracker</title>
    <link rel="icon" href="att-logo.svg?v=1" type="image/svg">
    <link rel="shortcut icon" href="att-logo.svg?v=1" type="image/svg">
    <link rel="apple-touch-icon" href="att-logo.svg?v=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Iceberg&family=Philosopher:wght@400;700&family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #8B4513;
            --primary-light: #A0522D;
            --primary-dark: #654321;
            --secondary: #D2691E;
            --accent: #CD853F;
            --light-grey: #F5F5DC;
            --bg-color: #FFF8DC;
            --dark-text: #2F1B14;
            --grey-text: #8B7355;
            --light-text: #ffffff;
            --green: #228B22;
            --green-dark: #006400;
            --red: #B22222;
            --red-dark: #8B0000;
            --blue-accent: #4682B4;
            --blue-accent-dark: #2F4F4F;
            --yellow: #DAA520;
            --yellow-dark: #B8860B;
            --border-color: #DEB887;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(139, 69, 19, 0.1);
        }

        [data-theme="dark"] {
            --primary: #A0522D;
            --primary-light: #CD853F;
            --primary-dark: #8B4513;
            --secondary: #F4A460;
            --accent: #DEB887;
            --light-grey: #2C2C2C;
            --bg-color: #1A1A1A;
            --dark-text: #E5E5E5;
            --grey-text: #B0B0B0;
            --light-text: #ffffff;
            --green: #32CD32;
            --green-dark: #228B22;
            --red: #FF6B6B;
            --red-dark: #DC143C;
            --blue-accent: #87CEEB;
            --blue-accent-dark: #4682B4;
            --yellow: #FFD700;
            --yellow-dark: #FFA500;
            --border-color: #404040;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Philosopher', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--dark-text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        [data-color-scheme="ocean"] {
            --primary: #2E86AB;
            --primary-light: #3498DB;
            --primary-dark: #1B5E7F;
            --secondary: #3498DB;
            --accent: #5DADE2;
            --green: #16A085;
            --green-dark: #138D75;
            --red: #E74C3C;
            --red-dark: #C0392B;
            --blue-accent: #3498DB;
            --blue-accent-dark: #2980B9;
            --yellow: #F39C12;
            --yellow-dark: #E67E22;
        }

        [data-color-scheme="forest"] {
            --primary: #2D5016;
            --primary-light: #4A7C59;
            --primary-dark: #1E3A0F;
            --secondary: #8FBC8F;
            --accent: #98D8C8;
            --green: #228B22;
            --green-dark: #006400;
            --red: #CD5C5C;
            --red-dark: #B22222;
            --blue-accent: #4682B4;
            --blue-accent-dark: #2F4F4F;
            --yellow: #DAA520;
            --yellow-dark: #B8860B;
        }

        [data-color-scheme="sunset"] {
            --primary: #D2691E;
            --primary-light: #FF7F50;
            --primary-dark: #A0522D;
            --secondary: #FF6347;
            --accent: #FFA07A;
            --green: #32CD32;
            --green-dark: #228B22;
            --red: #DC143C;
            --red-dark: #B22222;
            --blue-accent: #4169E1;
            --blue-accent-dark: #191970;
            --yellow: #FFD700;
            --yellow-dark: #FFA500;
        }

        [data-font="inter"] body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif !important;
        }

        [data-font="roboto"] body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif !important;
        }

        [data-font="philosopher"] body {
            font-family: 'Philosopher', serif !important;
        }
        
        [data-font="inter"] *:not(.app-header h1):not(h2):not(h3):not(h4):not(.nav-link) {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif !important;
        }

        [data-font="roboto"] *:not(.app-header h1):not(h2):not(h3):not(h4):not(.nav-link) {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif !important;
        }

        [data-font="philosopher"] *:not(.app-header h1):not(h2):not(h3):not(h4):not(.nav-link) {
            font-family: 'Philosopher', serif !important;
        }
        
        .app-header h1, h2, h3, h4, .nav-link {
            font-family: 'Iceberg', serif !important;
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--light-text);
            padding: 1.25rem 2.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Iceberg', serif;
        }
        
        .theme-toggle {
            background: none;
            border: none;
            color: var(--light-text);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }
        
        .theme-toggle svg {
            width: 20px;
            height: 20px;
        }

        .app-header h1 {
            font-family: 'Iceberg', serif;
            font-size: 1.75rem;
            font-weight: 600;
            margin: 0;
        }

        .app-nav {
            display: flex;
            gap: 1.5rem;
        }

        .nav-link {
            color: var(--light-text);
            text-decoration: none;
            font-size: 1rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            transform: scale(1);
        }

        .nav-link:hover {
            color: var(--light-grey);
            transform: scale(1.05);
        }

        .nav-link.active {
            font-weight: 700;
            border-bottom-color: var(--light-text);
        }

        main {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .user-bar {
            background-color: var(--light-grey);
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .user-info {
            font-weight: 600;
        }

        .user-semester {
            color: var(--grey-text);
        }

        .page {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .page.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .page-header h2 {
            font-family: 'Iceberg', serif;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .custom-dropdown {
            position: relative;
            user-select: none;
            min-width: 140px;
            touch-action: manipulation;
        }

        .dropdown-selected {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
            color: var(--light-text);
            padding: 0.875rem 1.25rem;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(210, 105, 30, 0.25);
            min-height: 44px;
            touch-action: manipulation;
        }
        
        .custom-dropdown.status-dropdown .dropdown-selected {
            border: none;
            color: var(--light-text);
        }

        .dropdown-selected:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(210, 105, 30, 0.35);
        }

        .dropdown-selected svg {
            width: 18px;
            height: 18px;
            transition: transform 0.3s ease;
        }

        .custom-dropdown.open .dropdown-selected svg {
            transform: rotate(180deg);
        }

        .dropdown-options {
            display: none;
            position: absolute;
            background: var(--light-grey);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow-y: auto;
            z-index: 1000;
            top: 110%;
            left: 0;
            width: 100%;
            max-height: 200px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            animation: dropdownFade 0.2s ease;
        }

        @keyframes dropdownFade {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .custom-dropdown.open .dropdown-options {
            display: block;
        }
        
        .custom-dropdown.open {
            z-index: 1001;
            position: relative;
        }

        .dropdown-option {
            padding: 0.875rem 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .dropdown-option {
            color: var(--dark-text);
        }
        
        .dropdown-option:hover {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
            color: white;
        }

        .custom-date-picker {
            position: relative;
            min-width: 200px;
        }

        .date-picker-selected {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
            color: var(--light-text);
            padding: 0.875rem 1.25rem;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(210, 105, 30, 0.25);
        }

        .date-picker-selected:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(210, 105, 30, 0.35);
        }

        .date-picker-calendar {
            display: none;
            position: absolute;
            background: var(--light-grey);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            z-index: 1001;
            top: 110%;
            left: 0;
            min-width: 280px;
            max-height: 350px;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            animation: dropdownFade 0.2s ease;
            padding: 1rem;
        }

        .custom-date-picker.open .date-picker-calendar {
            display: block;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .calendar-nav {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            font-family: 'Philosopher', sans-serif;
            transition: background 0.2s ease;
        }

        .calendar-nav {
            color: var(--dark-text);
        }
        
        .calendar-nav:hover {
            background: rgba(210, 105, 30, 0.1);
        }

        .calendar-month-year {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--dark-text);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--grey-text);
            padding: 0.5rem;
        }

        .calendar-day {
            text-align: center;
            padding: 0.75rem 0.5rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-weight: 500;
            color: var(--dark-text);
        }

        .calendar-day:hover {
            background: rgba(210, 105, 30, 0.1);
        }

        .calendar-day.selected {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
            color: white;
        }

        .calendar-day.other-month {
            color: #ccc;
        }

        .calendar-day.today {
            background: rgba(210, 105, 30, 0.2);
            font-weight: 600;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-family: 'Philosopher', sans-serif;
            color: var(--grey-text);
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-family: 'Philosopher', sans-serif;
        }

        .auth-form {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status-present { background-color: var(--green); }
        .status-absent { background-color: var(--red); }
        .status-permission { background-color: var(--blue-accent); }
        .status-late { background-color: var(--yellow); color: var(--dark-text) !important; }

        .data-row {
            background-color: var(--light-grey);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            font-size: 1.1rem;
            font-weight: 500;
            opacity: 0;
            transform: translateX(-20px);
            animation: slideInLeft 0.4s ease forwards;
            position: relative;
        }
        
        .data-row .custom-dropdown.open {
            z-index: 1002 !important;
        }
        
        .data-row .dropdown-options {
            z-index: 1002 !important;
        }
        
        @keyframes slideInLeft {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .subject-row-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .tick-btn {
            background-color: var(--green);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .tick-btn:hover {
            background-color: var(--green-dark);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        
        .tick-btn:disabled {
            background-color: #aaa;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .tick-btn svg {
            width: 24px;
            height: 24px;
        }

        .count-bubble {
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            color: var(--light-text);
            flex-shrink: 0;
        }
        
        .count-green { background-color: var(--green); }
        .count-red { background-color: var(--red); }
        .count-blue { background-color: var(--blue-accent); }
        .count-yellow { background-color: var(--yellow); color: var(--dark-text); }

        .total-header-row {
            display: flex;
            justify-content: flex-end;
            gap: 1.5rem;
            padding: 0 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .total-header-item {
            width: 44px;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--grey-text);
        }
        
        .total-subject-row .data-row-right {
            display: flex;
            gap: 1.5rem;
        }

        .settings-section {
            background-color: var(--light-grey);
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }
        
        .settings-section {
            overflow: visible !important;
        }
        
        .settings-content {
            overflow: visible !important;
        }
        
        #personalization-content .dropdown-options {
            z-index: 9999 !important;
            position: absolute !important;
            top: 110% !important;
            left: 0 !important;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }
        
        .settings-header.collapsible {
            cursor: pointer;
            user-select: none;
            position: relative;
            z-index: 1;
        }
        
        .collapse-icon {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
            color: var(--grey-text);
        }
        
        .settings-header.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }
        
        .settings-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .settings-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
            margin-bottom: 0;
        }

        .settings-header h3 {
            font-family: 'Iceberg', serif;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--light-text);
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            font-family: 'Philosopher', sans-serif;
            transition: all 0.2s ease;
        }
        
        .btn-green {
            background-color: var(--green);
        }
        
        .btn-green:hover {
            background-color: var(--green-dark);
        }

        .btn-red {
            background-color: var(--red);
        }
        .btn-red:hover {
            background-color: var(--red-dark);
        }

        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Philosopher', sans-serif;
            background-color: var(--bg-color);
            color: var(--dark-text);
        }
        
        .settings-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-radius: 8px;
            background-color: var(--bg-color);
            margin-bottom: 0.75rem;
            color: var(--dark-text);
        }
        
        .settings-list-item input {
            flex-grow: 1;
            margin-right: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            background-color: var(--bg-color);
            color: var(--dark-text);
        }
        
        .settings-list-item .custom-dropdown {
            min-width: 150px;
            margin-right: 1rem;
        }
        
        .settings-list-item .btn-group {
            display: flex;
            gap: 0.5rem;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-overlay.show .modal-content {
            animation: slideInUp 0.3s ease;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-content {
            background: var(--light-grey);
            padding: 2rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h4 {
            font-family: 'Iceberg', serif;
            font-size: 1.4rem;
        }
        
        .modal-close-btn {
            background: none;
            border: none;
            font-size: 1.75rem;
            cursor: pointer;
            color: var(--grey-text);
            font-family: 'Philosopher', sans-serif;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .no-data-message {
            background-color: var(--light-grey);
            padding: 2rem;
            border-radius: var(--border-radius);
            text-align: center;
            color: var(--grey-text);
            font-weight: 500;
        }
        
        .cute-loader {
            display: inline-block;
            position: relative;
            width: 40px;
            height: 40px;
            margin: 0 0.5rem;
        }
        
        .cute-loader::before {
            content: 'ðŸŒ¸';
            position: absolute;
            font-size: 20px;
            animation: bounce 1.4s ease-in-out infinite both;
        }
        
        .cute-loader::after {
            content: 'âœ¨';
            position: absolute;
            font-size: 16px;
            left: 24px;
            top: -4px;
            animation: sparkle 1.4s ease-in-out infinite both;
            animation-delay: 0.2s;
        }
        
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0.8) rotate(0deg);
                opacity: 0.7;
            }
            40% {
                transform: scale(1.2) rotate(10deg);
                opacity: 1;
            }
        }
        
        @keyframes sparkle {
            0%, 80%, 100% {
                transform: scale(0.5) rotate(0deg);
                opacity: 0.5;
            }
            40% {
                transform: scale(1) rotate(180deg);
                opacity: 1;
            }
        }
        
        .btn.loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }
        
        .btn.loading::after {
            content: 'ðŸ’–';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            animation: heartbeat 0.8s ease-in-out infinite;
        }
        
        @keyframes heartbeat {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.3);
            }
        }
        
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                padding: 1rem;
                gap: 1rem;
            }
            .app-nav {
                width: 100%;
                justify-content: space-around;
                gap: 0.5rem;
            }
            .nav-link {
                font-size: 0.85rem;
                padding: 0.5rem 0.25rem;
            }
            main {
                padding: 1rem 0.75rem;
            }
            .user-bar {
                flex-direction: column;
                gap: 0.5rem;
                padding: 1rem;
                font-size: 0.95rem;
                text-align: center;
            }
            
            .user-bar > div {
                text-align: center;
            }
            
            .page-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .page-header h2 {
                font-size: 1.3rem;
                text-align: center;
            }
            
            .data-row {
                flex-direction: row;
                align-items: center;
                padding: 1rem;
                gap: 0.5rem;
                justify-content: space-between;
            }
            
            .subject-row-right {
                width: 100%;
                justify-content: space-between;
                gap: 1rem;
            }
            
            .custom-dropdown {
                flex-grow: 1;
                min-width: auto;
            }
            
            .dropdown-selected {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
            
            .tick-btn {
                width: 40px;
                height: 40px;
                flex-shrink: 0;
            }
            
            .count-bubble {
                width: 40px;
                height: 40px;
                font-size: 0.9rem;
            }
            
            .total-header-row {
                display: flex;
                justify-content: space-around;
                gap: 0.75rem;
                padding: 0 1rem;
                margin-bottom: 0.5rem;
            }
            
            .total-header-item {
                font-size: 0.8rem;
                text-align: center;
            }
            
            .total-subject-row .data-row-right {
                display: flex;
                justify-content: space-around;
                gap: 0.3rem;
                padding: 0 1rem;
                margin-left: auto;
                width: 60%;
                transform: translateX(1.7rem);
            }
            
            .total-subject-row .count-bubble {
                width: 35px;
                height: 35px;
                font-size: 0.8rem;
            }
            
            .settings-section {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
            
            .settings-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .settings-header.collapsible {
                pointer-events: auto;
                z-index: 10;
            }
            
            .settings-list-item {
                flex-direction: column;
                gap: 0.75rem;
                align-items: stretch;
            }
            .settings-list-item input {
                margin-right: 0;
            }
            .settings-list-item .custom-dropdown {
                margin-right: 0;
            }
            .btn-group {
                justify-content: flex-end;
            }
            
            .modal-content {
                width: 95%;
                padding: 1.5rem;
                margin: 1rem;
            }
            
            .date-picker-calendar {
                min-width: 260px;
                max-height: 300px;
                left: 50%;
                transform: translateX(-50%);
            }
            
            .calendar-grid {
                gap: 2px;
            }
            
            .calendar-day {
                padding: 0.5rem 0.25rem;
                font-size: 0.9rem;
            }
            
            .form-input {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            #toast-message {
                bottom: 80px;
                left: 1rem;
                right: 1rem;
                transform: none;
                text-align: center;
            }
            
            .btn {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                min-height: 44px; /* Touch target size */
            }
        }
    </style>
</head>
<body>

    <header class="app-header">
        <div style="display: flex; align-items: center; gap: 0.75rem;">
            <img src="att-logo.svg" alt="Logo" style="width: 32px; height: 32px;">
            <h1>Attendance Tracker</h1>
        </div>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <nav class="app-nav">
                <a href="#" class="nav-link active" data-page="Home">Home</a>
                <a href="#" class="nav-link" data-page="WeeklyReport">Weekly Report</a>
                <a href="#" class="nav-link" data-page="Total">Total</a>
                <a href="#" class="nav-link" data-page="Settings">Settings</a>
            </nav>
            <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode">
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                </svg>
                <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="display: none;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                </svg>
            </button>
        </div>
    </header>

    <main>
        <div class="user-bar">
            <div>
                <span class="user-info" id="user-info-name">Hello, Student</span><br>
                <span class="user-major" id="user-info-major">Your Major</span>
            </div>
            <div style="text-align: right;">
                <span class="user-semester" id="user-info-semester">No semester selected</span><br>
                <span id="streak-display" style="color: var(--green); font-weight: 600; font-size: 0.9rem;">ðŸ”¥ 0 day streak</span>
            </div>
        </div>

        <div class="page active" data-page="Home">
            <div class="page-header">
                <div class="custom-dropdown" id="date-selector-dropdown">
                    <div class="dropdown-selected">
                        <span id="selected-date-display">Monday</span>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                    </div>
                    <div class="dropdown-options" id="date-selector-options">
                    </div>
                </div>
                <h2 id="home-day-title">Daily Attendance</h2>
            </div>
            <div class="page-content" id="home-content">
            </div>
        </div>

        <div class="page" data-page="WeeklyReport">
            <div class="page-header">
                <div class="custom-dropdown" id="week-selector-dropdown">
                    <div class="dropdown-selected">
                        <span id="selected-week-display">Week 1</span>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                    </div>
                    <div class="dropdown-options" id="week-selector-options">
                    </div>
                </div>
                <h2>Weekly Report</h2>
            </div>
            <div class="page-content" id="weekly-report-content">
                <div class="data-row">
                    <span>Present</span>
                    <div class="count-bubble count-green" id="weekly-present">0</div>
                </div>
                <div class="data-row">
                    <span>Absent</span>
                    <div class="count-bubble count-red" id="weekly-absent">0</div>
                </div>
                <div class="data-row">
                    <span>Permission</span>
                    <div class="count-bubble count-blue" id="weekly-permission">0</div>
                </div>
                <div class="data-row">
                    <span>Late</span>
                    <div class="count-bubble count-yellow" id="weekly-late">0</div>
                </div>
                
                <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Warning</h3>
                <div class="no-data-message" id="weekly-warning">
                    No warning yet, keep up the good work!
                </div>
            </div>
        </div>

        <div class="page" data-page="Total">
            <div class="page-header">
                <h2>All Subjects</h2>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="custom-dropdown" id="export-type-dropdown">
                        <div class="dropdown-selected">
                            <span id="export-type-display">Export to Excel</span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                        </div>
                        <div class="dropdown-options">
                            <div class="dropdown-option" data-value="weekly">Weekly Report</div>
                            <div class="dropdown-option" data-value="monthly">Monthly Report</div>
                            <div class="dropdown-option" data-value="semester">Full Semester</div>
                        </div>
                    </div>
                    <div class="total-header-row">
                        <span class="total-header-item">Present</span>
                        <span class="total-header-item">Absent</span>
                        <span class="total-header-item">Permit</span>
                        <span class="total-header-item">Late</span>
                    </div>
                </div>
            </div>
            <div class="page-content" id="total-content">
            </div>
        </div>

        <div class="page" data-page="Settings">
            <div class="settings-section">
                <div class="settings-header collapsible collapsed" data-collapse="profile">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <h3>Profile</h3>
                        <svg class="collapse-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                        </svg>
                    </div>
                    <div>
                        <button class="btn" id="auth-btn" style="margin-right: 0.5rem;">Sign In</button>
                        <button class="btn btn-red" id="signout-btn" style="display: none;">Sign Out</button>
                    </div>
                </div>
                <div class="settings-content collapsed" id="profile-content">
                    <div class="form-group">
                        <label for="setting-name">Name</label>
                        <input type="text" id="setting-name" class="form-input" placeholder="Your Name" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="setting-major">Major</label>
                        <input type="text" id="setting-major" class="form-input" placeholder="Your Major" autocomplete="off">
                    </div>
                    <div id="auth-status" style="margin-bottom: 1rem; padding: 0.75rem; border-radius: 8px; font-size: 0.9rem;"></div>
                    <button class="btn btn-green" id="save-profile-btn">Save Profile</button>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-header collapsible collapsed" data-collapse="semesters">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <h3>Manage Semesters</h3>
                        <svg class="collapse-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                        </svg>
                    </div>
                    <button class="btn btn-green" id="add-semester-btn">Add Semester</button>
                </div>
                <div class="settings-content collapsed" id="semesters-content">
                    <p style="margin-bottom: 1rem; color: var(--grey-text);">Manage your academic semesters:</p>
                    <div class="form-group">
                        <label>Current Semester</label>
                        <div class="custom-dropdown" id="current-semester-dropdown">
                            <div class="dropdown-selected">
                                <span id="current-semester-display">Select a semester...</span>
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                            </div>
                            <div class="dropdown-options" id="current-semester-options">
                            </div>
                        </div>
                    </div>
                    <div id="semesters-list">
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-header collapsible collapsed" data-collapse="subjects">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <h3>Manage Subjects</h3>
                        <svg class="collapse-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                        </svg>
                    </div>
                    <button class="btn btn-green" id="add-subject-btn">Add Subject</button>
                </div>
                <div class="settings-content collapsed" id="subjects-content">
                    <p style="margin-bottom: 1rem; color: var(--grey-text);">Subjects for current semester:</p>
                    <div id="subjects-list">
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-header collapsible collapsed" data-collapse="notifications">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <h3>Notifications</h3>
                        <svg class="collapse-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                        </svg>
                    </div>
                </div>
                <div class="settings-content collapsed" id="notifications-content">
                    <p style="color: var(--grey-text); margin-bottom: 1rem;">Get reminders for missed attendance and warnings</p>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-green" id="enable-notifications-btn">Enable Notifications</button>
                        <button class="btn btn-red" id="disable-notifications-btn">Disable Notifications</button>
                    </div>
                </div>
            </div>
            
            <div class="settings-section" id="account-management" style="display: none;">
                <div class="settings-header">
                    <h3>Account Management</h3>
                </div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                    <button class="btn" id="change-password-btn">Change Password</button>
                    <button class="btn" id="change-email-btn">Change Email</button>
                    <button class="btn btn-red" id="delete-account-btn">Delete Account</button>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-header collapsible collapsed" data-collapse="personalization">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <h3>Personalization</h3>
                        <svg class="collapse-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                        </svg>
                    </div>
                </div>
                <div class="settings-content collapsed" id="personalization-content">
                    <div class="form-group">
                        <label>Color Scheme</label>
                        <div class="custom-dropdown" id="color-scheme-dropdown">
                            <div class="dropdown-selected">
                                <span id="color-scheme-display">Default</span>
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                            </div>
                            <div class="dropdown-options">
                                <div class="dropdown-option" data-value="default">Default</div>
                                <div class="dropdown-option" data-value="ocean">Ocean Blue</div>
                                <div class="dropdown-option" data-value="forest">Forest Green</div>
                                <div class="dropdown-option" data-value="sunset">Sunset Orange</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Font Style</label>
                        <div class="custom-dropdown" id="font-dropdown">
                            <div class="dropdown-selected">
                                <span id="font-display">Philosopher</span>
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                            </div>
                            <div class="dropdown-options">
                                <div class="dropdown-option" data-value="philosopher">Philosopher</div>
                                <div class="dropdown-option" data-value="inter">Inter</div>
                                <div class="dropdown-option" data-value="roboto">Roboto</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-header">
                    <h3>Legal</h3>
                </div>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <a href="https://telegra.ph/PRIVACY-POLICY-11-17-295" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 500;">Privacy Policy</a>
                    <a href="https://telegra.ph/TERMS-OF-SERVICE-11-17-3" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 500;">Terms of Service</a>
                    <a href="#" id="report-problem-btn" style="color: var(--primary); text-decoration: none; font-weight: 500;">Report a Problem</a>
                    <a href="#" id="contact-us-btn" style="color: var(--primary); text-decoration: none; font-weight: 500;">Contact Us</a>
                </div>
            </div>
            
            <div style="text-align: center; padding: 1rem; color: var(--grey-text); font-size: 0.9rem; border-top: 1px solid var(--border-color); margin-top: 1rem;">
                <div>Â© 2025 Attendance Tracker. All rights reserved.</div>
                <div style="margin-top: 0.25rem;">Version 2.1.1.0</div>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="subject-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="subject-modal-title">Add Subject</h4>
                <button class="modal-close-btn" data-modal-close="subject-modal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="subject-modal-id">
                <div class="form-group">
                    <label for="subject-modal-name">Subject Name</label>
                    <input type="text" id="subject-modal-name" class="form-input" placeholder="e.g., Mathematics" autocomplete="off">
                </div>
                <div class="form-group">
                    <label>Day of Week</label>
                    <div class="custom-dropdown" id="subject-modal-day-dropdown">
                        <div class="dropdown-selected">
                            <span id="subject-modal-day-display">Select a day...</span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                        </div>
                        <div class="dropdown-options">
                            <div class="dropdown-option" data-value="Sunday">Sunday</div>
                            <div class="dropdown-option" data-value="Monday">Monday</div>
                            <div class="dropdown-option" data-value="Tuesday">Tuesday</div>
                            <div class="dropdown-option" data-value="Wednesday">Wednesday</div>
                            <div class="dropdown-option" data-value="Thursday">Thursday</div>
                            <div class="dropdown-option" data-value="Friday">Friday</div>
                            <div class="dropdown-option" data-value="Saturday">Saturday</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" data-modal-close="subject-modal">Cancel</button>
                <button class="btn btn-green" id="save-subject-btn">Save Subject</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="semester-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="semester-modal-title">Add Semester</h4>
                <button class="modal-close-btn" data-modal-close="semester-modal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="semester-modal-id">
                <div class="form-group">
                    <label for="semester-modal-name">Semester Name</label>
                    <input type="text" id="semester-modal-name" class="form-input" placeholder="e.g., Year 1, Semester I" autocomplete="off">
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <div class="custom-date-picker" id="semester-start-date-picker">
                        <div class="date-picker-selected">
                            <span id="semester-start-date-display">Select start date</span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 18px; height: 18px;"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5a2.25 2.25 0 002.25-2.25m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5a2.25 2.25 0 012.25 2.25v7.5" /></svg>
                        </div>
                        <div class="date-picker-calendar">
                            <div class="calendar-header">
                                <button class="calendar-nav" id="start-prev-month">â€¹</button>
                                <div class="calendar-month-year" id="start-month-year"></div>
                                <button class="calendar-nav" id="start-next-month">â€º</button>
                            </div>
                            <div class="calendar-grid" id="start-calendar-grid"></div>
                        </div>
                    </div>
                    <input type="hidden" id="semester-modal-start-date">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <div class="custom-date-picker" id="semester-end-date-picker">
                        <div class="date-picker-selected">
                            <span id="semester-end-date-display">Select end date</span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 18px; height: 18px;"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5a2.25 2.25 0 002.25-2.25m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5a2.25 2.25 0 012.25 2.25v7.5" /></svg>
                        </div>
                        <div class="date-picker-calendar">
                            <div class="calendar-header">
                                <button class="calendar-nav" id="end-prev-month">â€¹</button>
                                <div class="calendar-month-year" id="end-month-year"></div>
                                <button class="calendar-nav" id="end-next-month">â€º</button>
                            </div>
                            <div class="calendar-grid" id="end-calendar-grid"></div>
                        </div>
                    </div>
                    <input type="hidden" id="semester-modal-end-date">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" data-modal-close="semester-modal">Cancel</button>
                <button class="btn btn-green" id="save-semester-btn">Save Semester</button>
            </div>
        </div>
    </div>
    
    <div id="toast-message" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 1rem 2rem; border-radius: 8px; z-index: 2000; font-weight: 500;">
        Message
    </div>
    
    <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.3); z-index: 3000; align-items: center; justify-content: center;">
        <div style="background: var(--light-grey); padding: 2rem; border-radius: var(--border-radius); text-align: center; box-shadow: var(--shadow);">
            <div class="cute-loader"></div>
            <div style="margin-top: 1rem; color: var(--dark-text); font-weight: 500;">Saving your attendance... ðŸ¥°</div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="auth-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="auth-modal-title">Sign In</h4>
                <button class="modal-close-btn" data-modal-close="auth-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="signin">Sign In</button>
                    <button class="auth-tab" data-tab="signup">Sign Up</button>
                </div>
                
                <div class="auth-form" id="signin-form">
                    <div class="form-group">
                        <label for="signin-email">Email</label>
                        <input type="email" id="signin-email" class="form-input" placeholder="your@email.com" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="signin-password">Password</label>
                        <input type="password" id="signin-password" class="form-input" placeholder="Password" autocomplete="off">
                    </div>
                    <button class="btn btn-green" id="signin-btn" style="width: 100%; margin-top: 1rem;">Sign In</button>
                    <p style="font-size: 0.8rem; color: var(--grey-text); text-align: center; margin-top: 0.5rem;">By signing in, you agree to our <a href="https://telegra.ph/TERMS-OF-SERVICE-11-17-3" target="_blank" style="color: var(--primary);">Terms of Service</a> and <a href="https://telegra.ph/PRIVACY-POLICY-11-17-295" target="_blank" style="color: var(--primary);">Privacy Policy</a>.</p>
                </div>
                
                <div class="auth-form" id="signup-form" style="display: none;">
                    <div class="form-group">
                        <label for="signup-name">Name</label>
                        <input type="text" id="signup-name" class="form-input" placeholder="Your Name" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="signup-email">Email</label>
                        <input type="email" id="signup-email" class="form-input" placeholder="your@email.com" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Password</label>
                        <input type="password" id="signup-password" class="form-input" placeholder="Min 6 chars, 1 capital, 1 number" autocomplete="off">
                        <div id="password-strength" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
                    </div>
                    <button class="btn btn-green" id="signup-btn" style="width: 100%; margin-top: 1rem;">Create Account</button>
                    <p style="font-size: 0.8rem; color: var(--grey-text); text-align: center; margin-top: 0.5rem;">By creating an account, you agree to our <a href="https://telegra.ph/TERMS-OF-SERVICE-11-17-3" target="_blank" style="color: var(--primary);">Terms of Service</a> and <a href="https://telegra.ph/PRIVACY-POLICY-11-17-295" target="_blank" style="color: var(--primary);">Privacy Policy</a>.</p>
                </div>
                

            </div>
        </div>
    </div>

    <!-- Custom Input Modal -->
    <div class="modal-overlay" id="input-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="input-modal-title">Input Required</h4>
                <button class="modal-close-btn" data-modal-close="input-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="input-modal-message"></p>
                <div class="form-group">
                    <input type="text" id="input-modal-field" class="form-input" placeholder="Enter value">
                    <div id="input-modal-validation" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" data-modal-close="input-modal">Cancel</button>
                <button class="btn btn-green" id="input-modal-confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="confirm-modal-title">Confirm Action</h4>
                <button class="modal-close-btn" data-modal-close="confirm-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirm-modal-message"></p>
            </div>
            <div class="modal-footer">
                <button class="btn" data-modal-close="confirm-modal">Cancel</button>
                <button class="btn btn-red" id="confirm-modal-confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Report Problem Modal -->
    <div class="modal-overlay" id="report-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>Report a Problem</h4>
                <button class="modal-close-btn" data-modal-close="report-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Problem Type</label>
                    <div class="custom-dropdown" id="report-type-dropdown">
                        <div class="dropdown-selected">
                            <span id="report-type-display">Select problem type...</span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                        </div>
                        <div class="dropdown-options">
                            <div class="dropdown-option" data-value="Bug">Bug/Error</div>
                            <div class="dropdown-option" data-value="Crash">App Crash</div>
                            <div class="dropdown-option" data-value="Feature">Feature Request</div>
                            <div class="dropdown-option" data-value="Other">Other</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="report-description">Description</label>
                    <textarea id="report-description" class="form-input" rows="4" placeholder="Please describe the problem in detail..." style="resize: vertical; min-height: 100px;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" data-modal-close="report-modal">Cancel</button>
                <button class="btn btn-green" id="submit-report-btn">Submit Report</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            sendEmailVerification,
            sendPasswordResetEmail,
            updateEmail,
            updatePassword,
            deleteUser,
            reauthenticateWithCredential,
            EmailAuthProvider
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            addDoc,
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth;
        let userId = null;
        let currentSemesterId = null;
        let userProfile = {};
        let allSemesters = [];
        let allSubjects = [];
        let allAttendance = [];
        let currentPage = 'Home';
        let isAnonymous = false;
        let loginAttempts = {};
        let selectedDate = null; // For past day attendance
        let realTime = null; // Server time from API
        let timeOffset = 0; // Difference between server and local time

        const appId = 'attendance-tracker-app';
        const firebaseConfig = {
            apiKey: "AIzaSyDsuGdds2KAY-SsBtf3oiFpANohU30ArUU",
            authDomain: "attracker-unique-lisa.firebaseapp.com",
            projectId: "attracker-unique-lisa",
            storageBucket: "attracker-unique-lisa.firebasestorage.app",
            messagingSenderId: "19799307034",
            appId: "1:19799307034:web:c3009fbf189669a09872a3",
            measurementId: "G-ZKLDNEW47V"
        };

        const paths = {
            userProfile: () => `artifacts/${appId}/users/${userId}/profile/details`,
            semesters: () => `artifacts/${appId}/users/${userId}/semesters`,
            semesterDoc: (id) => `artifacts/${appId}/users/${userId}/semesters/${id}`,
            subjects: () => `artifacts/${appId}/users/${userId}/subjects`,
            subjectDoc: (id) => `artifacts/${appId}/users/${userId}/subjects/${id}`,
            attendance: () => `artifacts/${appId}/users/${userId}/attendanceRecords`,
        };

        const DAYS_OF_WEEK = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        
        async function fetchRealTime() {
            try {
                const response = await fetch('https://worldtimeapi.org/api/timezone/Asia/Bangkok');
                const data = await response.json();
                const serverTime = new Date(data.datetime);
                const localTime = new Date();
                
                timeOffset = serverTime.getTime() - localTime.getTime();
                realTime = serverTime;
                
                console.log('Bangkok time synced:', serverTime.toISOString());
                return serverTime;
            } catch (error) {
                console.warn('Failed to fetch Bangkok time, using local time:', error);
                return new Date(); // Fallback to local time
            }
        }
        
        function getRealTime() {
            if (realTime) {
                // Calculate current real time based on offset
                return new Date(new Date().getTime() + timeOffset);
            }
            return new Date(); // Fallback to local time
        }
        
        function getTodayDateString() {
            return getRealTime().toISOString().split('T')[0];
        }
        
        function getSelectedDateString() {
            return selectedDate || getTodayDateString();
        }
        
        function getDayNameFromDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return DAYS_OF_WEEK[date.getDay()];
        }
        
        function getAvailableDates() {
            const dates = [];
            const today = getRealTime();
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dayName = DAYS_OF_WEEK[date.getDay()];
                dates.push({
                    dateString: date.toISOString().split('T')[0],
                    displayName: dayName
                });
            }
            return dates;
        }
        
        function getCurrentDayName() {
            return DAYS_OF_WEEK[getRealTime().getDay()];
        }
        
        function getSemesterWeek(dateString, semester) {
            if (!semester || !semester.startDate) {
                return null;
            }
            try {
                const start = new Date(semester.startDate);
                const today = new Date(dateString);

                start.setHours(0, 0, 0, 0);
                today.setHours(0, 0, 0, 0);

                // Convert Sunday=0 to Monday=0 system
                const startDayOfWeek = (start.getDay() + 6) % 7; // Monday=0, Sunday=6
                const startDateOfWeek = new Date(start.getTime() - startDayOfWeek * 24 * 60 * 60 * 1000);

                const diffTime = today.getTime() - startDateOfWeek.getTime();
                if (diffTime < 0) {
                    return null;
                }
                
                const diffDays = diffTime / (1000 * 60 * 60 * 24);
                const weekNumber = Math.floor(diffDays / 7) + 1;
                
                return weekNumber;
            } catch (e) {
                console.error("Error calculating semester week:", e);
                return null;
            }
        }

        function calculateWarning(late, permission, absent) {
            // Calculate warning score using TOTAL semester counts (not weekly)
            // Formula: absent + (permission + floor(late/3))
            const score = absent + (permission + Math.floor(late / 3));
            
            if (absent > 2 || score > 4) {
                return { status: 'RED ERROR WARNING', color: 'var(--red)' };
            } else if (score <= 2) {
                return { status: 'Good', color: 'var(--green)' };
            } else if (score === 3) {
                return { status: 'FIRST WARNING', color: 'var(--yellow-dark)' };
            } else if (score === 4) {
                return { status: 'LAST WARNING', color: 'var(--red)' };
            }
            return { status: '', color: 'var(--grey-text)' };
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast-message');
            toast.innerHTML = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, duration);
        }
        
        function showContactToast() {
            const email = 'lyssa.phat@gmail.com';
            const toast = document.getElementById('toast-message');
            toast.innerHTML = `
                Contact us at: ${email} 
                <button onclick="copyEmail('${email}')" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; border: none; border-radius: 4px; background: var(--primary); color: white; cursor: pointer; font-size: 0.8rem;">Copy</button>
            `;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 8000);
        }
        
        function copyEmail(email) {
            navigator.clipboard.writeText(email).then(() => {
                showToast('Email copied to clipboard!', 2000);
            }).catch(() => {
                showToast('Failed to copy email', 2000);
            });
        }
        
        window.copyEmail = copyEmail;
        
        // Bulk attendance functions
        async function markAllSubjects(status) {
            const currentDate = getSelectedDateString();
            const dayName = getDayNameFromDate(currentDate);
            const subjectsForDay = allSubjects.filter(s => s.day === dayName && s.semesterId === currentSemesterId);
            const attendanceForDay = allAttendance.filter(r => r.date === currentDate);
            
            // Only mark subjects that haven't been marked yet
            const unmarkedSubjects = subjectsForDay.filter(subject => 
                !attendanceForDay.find(r => r.subjectId === subject.id)
            );
            
            if (unmarkedSubjects.length === 0) {
                showToast('All subjects for today have already been marked!');
                return;
            }
            
            const currentSem = allSemesters.find(s => s.id === currentSemesterId);
            const semesterWeek = getSemesterWeek(currentDate, currentSem);
            
            try {
                showCuteLoader();
                
                // Create attendance records for all unmarked subjects
                const promises = unmarkedSubjects.map(subject => {
                    const record = {
                        subjectId: subject.id,
                        semesterId: currentSemesterId,
                        date: currentDate,
                        status: status,
                        semesterWeek: semesterWeek,
                        createdAt: serverTimestamp()
                    };
                    return addDoc(collection(db, paths.attendance()), record);
                });
                
                await Promise.all(promises);
                hideCuteLoader();
                showToast(`All subjects marked as ${status}! ðŸŽ‰`);
                
                // Update streak after bulk attendance
                setTimeout(() => {
                    updateStreak();
                    checkWarningStatus();
                }, 1000);
            } catch (error) {
                console.error('Error saving bulk attendance:', error);
                hideCuteLoader();
                showToast('Error saving attendance.');
            }
        }
        
        function sendWeeklyReport() {
            if (!currentSemesterId) return;
            
            const currentSemAttendance = allAttendance.filter(r => r.semesterId === currentSemesterId);
            const currentSem = allSemesters.find(s => s.id === currentSemesterId);
            const currentWeek = getSemesterWeek(getTodayDateString(), currentSem);
            const weeklyData = currentSemAttendance.filter(r => r.semesterWeek === currentWeek);
            
            const counts = { Present: 0, Absent: 0, Permission: 0, Late: 0 };
            weeklyData.forEach(r => {
                if (counts.hasOwnProperty(r.status)) counts[r.status]++;
            });
            
            const total = Object.values(counts).reduce((a, b) => a + b, 0);
            const percentage = total > 0 ? ((counts.Present / total) * 100).toFixed(1) : '0.0';
            
            const message = `ðŸ“Š Week ${currentWeek} Report: ${counts.Present}P ${counts.Absent}A ${counts.Permission}Pe ${counts.Late}L (${percentage}% attendance)`;
            
            sendNotification('Weekly Attendance Report', message);
            showToast(`ðŸ“Š ${message}`, 6000);
        }
        
        window.markAllSubjects = markAllSubjects;
        
        // Cute loading functions
        function showCuteLoader() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        
        function hideCuteLoader() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
        
        // Streak functionality
        function calculateStreak() {
            if (!currentSemesterId) return 0;
            
            const currentSemAttendance = allAttendance.filter(r => r.semesterId === currentSemesterId);
            const currentSemSubjects = allSubjects.filter(s => s.semesterId === currentSemesterId);
            
            // Group attendance by date
            const attendanceByDate = {};
            currentSemAttendance.forEach(record => {
                if (!attendanceByDate[record.date]) {
                    attendanceByDate[record.date] = [];
                }
                attendanceByDate[record.date].push(record);
            });
            
            // Get all dates with attendance, sorted newest first
            const dates = Object.keys(attendanceByDate).sort((a, b) => new Date(b) - new Date(a));
            
            let streak = 0;
            for (const date of dates) {
                const dayName = getDayNameFromDate(date);
                const subjectsForDay = currentSemSubjects.filter(s => s.day === dayName);
                const attendanceForDay = attendanceByDate[date];
                
                // Check if all subjects for this day are marked as Present or Late
                const allPresentOrLate = subjectsForDay.every(subject => {
                    const record = attendanceForDay.find(r => r.subjectId === subject.id);
                    return record && (record.status === 'Present' || record.status === 'Late');
                });
                
                if (allPresentOrLate && subjectsForDay.length > 0) {
                    streak++;
                } else {
                    break; // Streak broken
                }
            }
            
            return streak;
        }
        
        function updateStreakDisplay() {
            const streak = calculateStreak();
            const streakEl = document.getElementById('streak-display');
            
            if (streak === 0) {
                streakEl.textContent = 'ðŸ”¥ 0 day streak';
                streakEl.style.color = 'var(--grey-text)';
            } else if (streak === 1) {
                streakEl.textContent = `ðŸ”¥ 1 day streak`;
                streakEl.style.color = 'var(--green)';
            } else {
                streakEl.textContent = `ðŸ”¥ ${streak} days streak`;
                streakEl.style.color = 'var(--green)';
            }
        }
        
        function updateStreak() {
            const oldStreak = calculateStreak();
            
            // Wait for data to update, then check new streak
            setTimeout(() => {
                const newStreak = calculateStreak();
                updateStreakDisplay();
                
                // Show streak notifications
                if (newStreak > oldStreak && newStreak > 0) {
                    const messages = {
                        1: "ðŸ”¥ Great start! 1 day streak!",
                        3: "ðŸ”¥ Amazing! 3 day streak! Keep it up!",
                        5: "ðŸ”¥ Fantastic! 5 day streak! You're on fire!",
                        7: "ðŸ”¥ Incredible! 1 week streak! Outstanding!",
                        10: "ðŸ”¥ Phenomenal! 10 day streak! You're unstoppable!",
                        14: "ðŸ”¥ Legendary! 2 week streak! Absolutely amazing!",
                        21: "ðŸ”¥ Epic! 3 week streak! You're a champion!",
                        30: "ðŸ”¥ Mythical! 30 day streak! Attendance master!"
                    };
                    
                    const message = messages[newStreak] || `ðŸ”¥ Yay! ${newStreak} day streak! Keep it up!`;
                    showToast(message, 4000);
                    
                    // Send notification if enabled
                    if ('Notification' in window && Notification.permission === 'granted') {
                        sendNotification('Streak Achievement!', message.replace('ðŸ”¥ ', ''));
                    }
                } else if (newStreak === 0 && oldStreak > 0) {
                    showToast('ðŸ’” Streak broken! Start fresh tomorrow!', 3000);
                }
            }, 500);
        }

        function initializeCustomDropdowns() {
            document.body.addEventListener('click', (e) => {
                if (!e.target.closest('.custom-dropdown') && !e.target.closest('.custom-date-picker')) {
                    document.querySelectorAll('.custom-dropdown.open').forEach(dropdown => {
                        dropdown.classList.remove('open');
                        const dataRow = dropdown.closest('.data-row');
                        if (dataRow) {
                            dataRow.style.zIndex = '';
                        }
                    });
                    document.querySelectorAll('.custom-date-picker.open').forEach(picker => {
                        picker.classList.remove('open');
                    });
                }
                
                const selected = e.target.closest('.dropdown-selected');
                if (selected) {
                    const dropdown = selected.closest('.custom-dropdown');
                    
                    // Close all other dropdowns first
                    document.querySelectorAll('.custom-dropdown.open').forEach(otherDropdown => {
                        if (otherDropdown !== dropdown) {
                            otherDropdown.classList.remove('open');
                            const otherDataRow = otherDropdown.closest('.data-row');
                            if (otherDataRow) {
                                otherDataRow.style.zIndex = '';
                            }
                        }
                    });
                    
                    dropdown.classList.toggle('open');
                    

                    
                    // Ensure dropdown appears on top for data rows
                    if (dropdown.classList.contains('open')) {
                        const dataRow = dropdown.closest('.data-row');
                        if (dataRow) {
                            dataRow.style.zIndex = '1003';
                            dataRow.style.position = 'relative';
                        }
                    } else {
                        const dataRow = dropdown.closest('.data-row');
                        if (dataRow) {
                            dataRow.style.zIndex = '';
                        }
                    }
                }
                
                const dateSelected = e.target.closest('.date-picker-selected');
                if (dateSelected) {
                    const picker = dateSelected.closest('.custom-date-picker');
                    
                    // Close all other date pickers first
                    document.querySelectorAll('.custom-date-picker.open').forEach(otherPicker => {
                        if (otherPicker !== picker) {
                            otherPicker.classList.remove('open');
                        }
                    });
                    
                    // Toggle the clicked one
                    picker.classList.toggle('open');
                }
                
                const option = e.target.closest('.dropdown-option');
                if (option) {
                    const dropdown = option.closest('.custom-dropdown');
                    const selectedDisplay = dropdown.querySelector('.dropdown-selected span');
                    const value = option.dataset.value;
                    
                    selectedDisplay.textContent = option.textContent;
                    dropdown.dataset.value = value;
                    dropdown.classList.remove('open');
                    
                    if (dropdown.classList.contains('status-dropdown')) {
                        const selectedBox = dropdown.querySelector('.dropdown-selected');
                        selectedBox.className = 'dropdown-selected';
                        selectedBox.classList.add(`status-${value.toLowerCase()}`);
                    }
                    
                    dropdown.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
        }

        function initializeDatePickers() {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const dayHeaders = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];

            function createDatePicker(pickerId, displayId, hiddenInputId, monthYearId, gridId, prevBtnId, nextBtnId) {
                let currentDate = new Date();
                let selectedDate = null;

                function renderCalendar() {
                    const monthYear = document.getElementById(monthYearId);
                    const grid = document.getElementById(gridId);
                    
                    monthYear.textContent = `${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
                    
                    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                    const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                    const startDate = new Date(firstDay);
                    startDate.setDate(startDate.getDate() - firstDay.getDay());
                    
                    grid.innerHTML = '';
                    
                    dayHeaders.forEach(day => {
                        const dayHeader = document.createElement('div');
                        dayHeader.className = 'calendar-day-header';
                        dayHeader.textContent = day;
                        grid.appendChild(dayHeader);
                    });
                    
                    for (let i = 0; i < 42; i++) {
                        const date = new Date(startDate);
                        date.setDate(startDate.getDate() + i);
                        
                        const dayElement = document.createElement('div');
                        dayElement.className = 'calendar-day';
                        dayElement.textContent = date.getDate();
                        
                        if (date.getMonth() !== currentDate.getMonth()) {
                            dayElement.classList.add('other-month');
                        }
                        
                        if (date.toDateString() === new Date().toDateString()) {
                            dayElement.classList.add('today');
                        }
                        
                        if (selectedDate && date.toDateString() === selectedDate.toDateString()) {
                            dayElement.classList.add('selected');
                        }
                        
                        dayElement.addEventListener('click', () => {
                            selectedDate = new Date(date);
                            const display = document.getElementById(displayId);
                            const hiddenInput = document.getElementById(hiddenInputId);
                            
                            display.textContent = selectedDate.toLocaleDateString('en-US', { 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            });
                            
                            // Fix timezone issue by using local date string format
                            const year = selectedDate.getFullYear();
                            const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
                            const day = String(selectedDate.getDate()).padStart(2, '0');
                            hiddenInput.value = `${year}-${month}-${day}`;
                            
                            document.getElementById(pickerId).classList.remove('open');
                        });
                        
                        grid.appendChild(dayElement);
                    }
                }
                
                document.getElementById(prevBtnId).addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar();
                });
                
                document.getElementById(nextBtnId).addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar();
                });
                
                renderCalendar();
            }

            createDatePicker(
                'semester-start-date-picker',
                'semester-start-date-display', 
                'semester-modal-start-date',
                'start-month-year',
                'start-calendar-grid',
                'start-prev-month',
                'start-next-month'
            );

            createDatePicker(
                'semester-end-date-picker',
                'semester-end-date-display',
                'semester-modal-end-date', 
                'end-month-year',
                'end-calendar-grid',
                'end-prev-month',
                'end-next-month'
            );
        }
        
        function initializeModals() {
            try {
                console.log('Initializing modals...');
                
                document.body.addEventListener('click', (e) => {
                    const modalClose = e.target.closest('[data-modal-close]');
                    if (modalClose) {
                        const modalId = modalClose.dataset.modalClose;
                        const modal = document.getElementById(modalId);
                        if (modal) {
                            modal.classList.remove('show');
                        }
                    }
                });
                
                // Add subject button
                const addSubjectBtn = document.getElementById('add-subject-btn');
                if (addSubjectBtn) {
                    addSubjectBtn.addEventListener('click', () => {
                        console.log('Add subject button clicked');
                        openSubjectModal();
                    });
                } else {
                    console.error('Add subject button not found');
                }
                
                // Add semester button
                const addSemesterBtn = document.getElementById('add-semester-btn');
                if (addSemesterBtn) {
                    addSemesterBtn.addEventListener('click', () => {
                        console.log('Add semester button clicked');
                        openSemesterModal();
                    });
                } else {
                    console.error('Add semester button not found');
                }
                
                // Save buttons
                const saveSubjectBtn = document.getElementById('save-subject-btn');
                if (saveSubjectBtn) {
                    saveSubjectBtn.addEventListener('click', handleSaveSubject);
                }
                
                const saveSemesterBtn = document.getElementById('save-semester-btn');
                if (saveSemesterBtn) {
                    saveSemesterBtn.addEventListener('click', handleSaveSemester);
                }
                
                console.log('Modals initialized successfully');
            } catch (error) {
                console.error('Error initializing modals:', error);
            }
            
            // Form navigation for subject modal
            document.getElementById('subject-modal-name').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const name = document.getElementById('subject-modal-name').value;
                    const day = document.getElementById('subject-modal-day-dropdown').dataset.value;
                    if (name && day) handleSaveSubject();
                }
            });
            
            // Form navigation for semester modal
            document.getElementById('semester-modal-name').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const name = document.getElementById('semester-modal-name').value;
                    const startDate = document.getElementById('semester-modal-start-date').value;
                    const endDate = document.getElementById('semester-modal-end-date').value;
                    if (name && startDate && endDate) handleSaveSemester();
                }
            });
            
            // Enter key for report modal
            document.getElementById('report-description').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    handleSubmitReport();
                }
            });
        }

        function initializeAuth() {
            try {
                console.log('Initializing auth...');
                
                document.querySelectorAll('.auth-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const tabType = e.target.dataset.tab;
                        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        
                        document.getElementById('signin-form').style.display = tabType === 'signin' ? 'block' : 'none';
                        document.getElementById('signup-form').style.display = tabType === 'signup' ? 'block' : 'none';
                        document.getElementById('auth-modal-title').textContent = tabType === 'signin' ? 'Sign In' : 'Sign Up';
                    });
                });
                
                // Auth button
                const authBtn = document.getElementById('auth-btn');
                if (authBtn) {
                    authBtn.addEventListener('click', () => {
                        console.log('Auth button clicked');
                        openModal('auth-modal');
                    });
                }
                
                // Sign out button
                const signoutBtn = document.getElementById('signout-btn');
                if (signoutBtn) {
                    signoutBtn.addEventListener('click', () => {
                        console.log('Sign out button clicked');
                        handleSignOut();
                    });
                } else {
                    console.error('Sign out button not found');
                }
                
                // Sign in/up buttons
                const signinBtn = document.getElementById('signin-btn');
                if (signinBtn) {
                    signinBtn.addEventListener('click', handleSignIn);
                }
                
                const signupBtn = document.getElementById('signup-btn');
                if (signupBtn) {
                    signupBtn.addEventListener('click', handleSignUp);
                }
                
                console.log('Auth initialized successfully');
            } catch (error) {
                console.error('Error initializing auth:', error);
            }
            
            // Form navigation for signin
            document.getElementById('signin-email').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('signin-password').focus();
                }
            });
            document.getElementById('signin-password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const email = document.getElementById('signin-email').value;
                    const password = document.getElementById('signin-password').value;
                    if (email && password) handleSignIn();
                }
            });
            
            // Form navigation for signup
            document.getElementById('signup-name').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('signup-email').focus();
                }
            });
            document.getElementById('signup-email').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('signup-password').focus();
                }
            });
            document.getElementById('signup-password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const name = document.getElementById('signup-name').value;
                    const email = document.getElementById('signup-email').value;
                    const password = document.getElementById('signup-password').value;
                    if (name && email && password) handleSignUp();
                }
            });
            
            // Password strength indicator
            document.getElementById('signup-password').addEventListener('input', updatePasswordStrength);
            
            // Notification permission
            document.getElementById('enable-notifications-btn').addEventListener('click', requestNotificationPermission);
            document.getElementById('disable-notifications-btn').addEventListener('click', disableNotifications);
        }

        async function handleSignIn() {
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            
            if (!email || !password) {
                showToast('Please fill in all fields');
                return;
            }
            
            if (!loginAttempts[email]) {
                loginAttempts[email] = 0;
            }
            
            if (loginAttempts[email] >= 5) {
                showToast('Account locked. Contact admin at lyssa.phat@gmail.com');
                return;
            }
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginAttempts[email] = 0;
                closeModal('auth-modal');
                showToast('Signed in successfully!');
            } catch (error) {
                if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    loginAttempts[email]++;
                    
                    if (loginAttempts[email] >= 5) {
                        showToast('Too many failed attempts. Account locked. Contact admin at lyssa.phat@gmail.com');
                    } else if (loginAttempts[email] > 1) {
                        showResetPasswordOption(email);
                        showToast(`Wrong password. ${5 - loginAttempts[email]} attempts remaining.`);
                    } else {
                        showToast('Wrong password. Try again.');
                    }
                } else {
                    showToast('Sign in failed: ' + error.message);
                }
            }
        }
        
        function showResetPasswordOption(email) {
            const resetBtn = document.getElementById('reset-password-btn');
            if (!resetBtn) {
                const btn = document.createElement('button');
                btn.id = 'reset-password-btn';
                btn.className = 'btn';
                btn.textContent = 'Reset Password';
                btn.style.width = '100%';
                btn.style.marginTop = '0.5rem';
                btn.onclick = () => handlePasswordReset(email);
                document.getElementById('signin-form').appendChild(btn);
            }
        }
        
        async function handlePasswordReset(email) {
            try {
                await sendPasswordResetEmail(auth, email);
                showToast('Password reset email sent!');
            } catch (error) {
                showToast('Failed to send reset email: ' + error.message);
            }
        }

        async function handleSignUp() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const name = document.getElementById('signup-name').value;
            
            if (!email || !password || !name) {
                showToast('Please fill in all fields');
                return;
            }
            
            const validation = validatePassword(password);
            if (!validation.valid) {
                showToast('Password must be at least 6 characters with 1 capital letter and 1 number');
                return;
            }
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await sendEmailVerification(userCredential.user);
                await setDoc(doc(db, paths.userProfile()), { name, major: '' }, { merge: true });
                closeModal('auth-modal');
                showToast('Account created! Please check your email to verify your account.');
            } catch (error) {
                showToast('Sign up failed: ' + error.message);
            }
        }



        async function handleSignOut() {
            const confirmed = await showConfirmModal('Sign Out', 'Are you sure you want to sign out?');
            if (!confirmed) return;
            
            try {
                // Clear user data immediately
                userId = null;
                currentSemesterId = null;
                userProfile = {};
                allSemesters = [];
                allSubjects = [];
                allAttendance = [];
                selectedDate = null;
                
                // Reset UI to default state with null checks
                const userInfoName = document.getElementById('user-info-name');
                if (userInfoName) userInfoName.textContent = 'Hello, Student';
                
                const userInfoMajor = document.getElementById('user-info-major');
                if (userInfoMajor) userInfoMajor.textContent = 'Your Major';
                
                const userInfoSemester = document.getElementById('user-info-semester');
                if (userInfoSemester) userInfoSemester.textContent = 'No semester selected';
                
                // Clear settings form fields
                const settingName = document.getElementById('setting-name');
                if (settingName) settingName.value = '';
                
                const settingMajor = document.getElementById('setting-major');
                if (settingMajor) settingMajor.value = '';
                
                const currentSemesterDisplay = document.getElementById('current-semester-display');
                if (currentSemesterDisplay) currentSemesterDisplay.textContent = 'Select a semester...';
                
                const currentSemesterDropdown = document.getElementById('current-semester-dropdown');
                if (currentSemesterDropdown) currentSemesterDropdown.dataset.value = '';
                
                // Clear all page content
                const homeContent = document.getElementById('home-content');
                if (homeContent) homeContent.innerHTML = '<div class="no-data-message">Please sign in to view your attendance.</div>';
                
                const weeklyReportContent = document.getElementById('weekly-report-content');
                if (weeklyReportContent) weeklyReportContent.innerHTML = '<div class="no-data-message">Please sign in to view reports.</div>';
                
                const totalContent = document.getElementById('total-content');
                if (totalContent) totalContent.innerHTML = '<div class="no-data-message">Please sign in to view totals.</div>';
                
                // Clear settings lists
                const semestersList = document.getElementById('semesters-list');
                if (semestersList) semestersList.innerHTML = '<div class="no-data-message">No semesters added yet.</div>';
                
                const subjectsList = document.getElementById('subjects-list');
                if (subjectsList) subjectsList.innerHTML = '<div class="no-data-message">No subjects added for this semester.</div>';
                
                const currentSemesterOptions = document.getElementById('current-semester-options');
                if (currentSemesterOptions) currentSemesterOptions.innerHTML = '<div class="dropdown-option">No semesters</div>';
                
                // Clear weekly report counters
                const weeklyPresent = document.getElementById('weekly-present');
                if (weeklyPresent) weeklyPresent.textContent = '0';
                
                const weeklyAbsent = document.getElementById('weekly-absent');
                if (weeklyAbsent) weeklyAbsent.textContent = '0';
                
                const weeklyPermission = document.getElementById('weekly-permission');
                if (weeklyPermission) weeklyPermission.textContent = '0';
                
                const weeklyLate = document.getElementById('weekly-late');
                if (weeklyLate) weeklyLate.textContent = '0';
                
                const weeklyWarning = document.getElementById('weekly-warning');
                if (weeklyWarning) weeklyWarning.innerHTML = '<div class="no-data-message">No warning yet, keep up the good work!</div>';
                
                // Clear week selector
                const selectedWeekDisplay = document.getElementById('selected-week-display');
                if (selectedWeekDisplay) selectedWeekDisplay.textContent = 'Week 1';
                
                const weekSelectorDropdown = document.getElementById('week-selector-dropdown');
                if (weekSelectorDropdown) weekSelectorDropdown.dataset.value = '1';
                
                const weekSelectorOptions = document.getElementById('week-selector-options');
                if (weekSelectorOptions) weekSelectorOptions.innerHTML = '<div class="dropdown-option" data-value="">No data</div>';
                
                // Clear date selector
                const selectedDateDisplay = document.getElementById('selected-date-display');
                if (selectedDateDisplay) selectedDateDisplay.textContent = 'Monday';
                
                const dateSelectorDropdown = document.getElementById('date-selector-dropdown');
                if (dateSelectorDropdown) dateSelectorDropdown.dataset.value = '';
                
                const dateSelectorOptions = document.getElementById('date-selector-options');
                if (dateSelectorOptions) dateSelectorOptions.innerHTML = '';
                
                // Clear auth status immediately
                const authStatus = document.getElementById('auth-status');
                if (authStatus) authStatus.innerHTML = '<div style="background: var(--red); color: white; padding: 0.5rem; border-radius: 6px;">Not signed in</div>';
                
                const accountManagement = document.getElementById('account-management');
                if (accountManagement) accountManagement.style.display = 'none';
                
                await signOut(auth);
                showToast('Signed out successfully');
            } catch (error) {
                showToast('Sign out failed: ' + error.message);
            }
        }
        
        async function sendVerificationEmail() {
            try {
                await sendEmailVerification(auth.currentUser);
                showToast('Verification email sent! Please check your inbox.');
            } catch (error) {
                showToast('Failed to send verification email: ' + error.message);
            }
        }
        
        window.sendVerificationEmail = sendVerificationEmail;
        
        // Notification functions
        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    showToast('Notifications enabled!');
                    scheduleNotifications();
                } else {
                    showToast('Notifications disabled. Enable in browser settings for reminders.');
                }
            }
        }
        
        function disableNotifications() {
            showToast('To disable notifications, go to your browser settings and block notifications for this site.');
        }
        
        function sendNotification(title, body, icon = null) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: icon || 'att-logo.svg',
                    badge: 'att-logo.svg'
                });
            }
        }
        
        // Track notification state to prevent spam
        let lastNotificationDate = null;
        let hasNotifiedToday = false;
        
        function checkMissedAttendance() {
            const today = getCurrentDayName();
            const todayDate = getTodayDateString();
            const subjectsToday = allSubjects.filter(s => s.day === today && s.semesterId === currentSemesterId);
            const attendanceToday = allAttendance.filter(r => r.date === todayDate);
            
            // Reset notification state at midnight
            if (lastNotificationDate !== todayDate) {
                hasNotifiedToday = false;
                lastNotificationDate = todayDate;
            }
            
            const missedSubjects = subjectsToday.filter(subject => 
                !attendanceToday.find(r => r.subjectId === subject.id)
            );
            
            // Only send notification if there are missed subjects and we haven't notified yet today
            if (missedSubjects.length > 0 && !hasNotifiedToday) {
                const subjectNames = missedSubjects.map(s => s.name).join(', ');
                const message = missedSubjects.length === 1 
                    ? `Don't forget to mark attendance for: ${subjectNames}`
                    : `Don't forget to mark attendance for ${missedSubjects.length} subjects: ${subjectNames}`;
                
                sendNotification('Attendance Reminder', message);
                hasNotifiedToday = true;
                
                console.log(`Notification sent for ${missedSubjects.length} missed subjects`);
            }
        }
        
        function checkWarningStatus() {
            const currentSemAttendance = allAttendance.filter(r => r.semesterId === currentSemesterId);
            const totals = { Present: 0, Absent: 0, Permission: 0, Late: 0 };
            
            currentSemAttendance.forEach(r => {
                if (totals.hasOwnProperty(r.status)) {
                    totals[r.status]++;
                }
            });
            
            const warning = calculateWarning(totals.Late, totals.Permission, totals.Absent);
            
            if (warning.status === 'FIRST WARNING' || warning.status === 'LAST WARNING' || warning.status === 'RED ERROR WARNING') {
                sendNotification(
                    'Attendance Warning',
                    `${warning.status}: ${totals.Absent} absent, ${totals.Permission} permission, ${totals.Late} late`
                );
            }
        }
        
        function scheduleNotifications() {
            // Check every minute for precise timing
            setInterval(() => {
                const now = getRealTime();
                const hour = now.getHours();
                const minute = now.getMinutes();
                const dayOfWeek = now.getDay(); // 0 = Sunday, 6 = Saturday
                
                // Reset notification state at midnight (00:00)
                if (hour === 0 && minute === 0) {
                    hasNotifiedToday = false;
                    console.log('Notification state reset at midnight');
                }
                
                // First reminder at 5:30 PM (17:30)
                if (hour === 17 && minute === 30) {
                    checkMissedAttendance();
                }
                
                // Hourly reminders from 6:00 PM to 11:00 PM (every hour on the hour)
                // This ensures only ONE notification per hour until midnight
                if (minute === 0 && hour >= 18 && hour <= 23) {
                    // Reset the notification flag to allow hourly reminders
                    hasNotifiedToday = false;
                    checkMissedAttendance();
                }
                
                // Daily warning check at 6 PM
                if (hour === 18 && minute === 0) {
                    checkWarningStatus();
                }
                
                // Weekly report notification - Sunday at 8 PM
                if (dayOfWeek === 0 && hour === 20 && minute === 0) {
                    sendWeeklyReport();
                }
            }, 60 * 1000); // Every minute for precise timing
        }
        
        function validatePassword(password) {
            const hasCapital = /[A-Z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const minLength = password.length >= 6;
            
            return {
                valid: hasCapital && hasNumber && minLength,
                hasCapital,
                hasNumber,
                minLength
            };
        }
        
        function getPasswordStrength(password) {
            let score = 0;
            if (password.length >= 6) score++;
            if (password.length >= 8) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[a-z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^A-Za-z0-9]/.test(password)) score++;
            
            if (score <= 2) return { strength: 'Weak', color: 'var(--red)' };
            if (score <= 4) return { strength: 'Medium', color: 'var(--yellow-dark)' };
            return { strength: 'Strong', color: 'var(--green)' };
        }
        
        function updatePasswordStrength() {
            const password = document.getElementById('signup-password').value;
            const strengthEl = document.getElementById('password-strength');
            
            if (!password) {
                strengthEl.innerHTML = '';
                return;
            }
            
            const validation = validatePassword(password);
            const strength = getPasswordStrength(password);
            
            let requirements = [];
            if (!validation.minLength) requirements.push('6+ characters');
            if (!validation.hasCapital) requirements.push('1 capital letter');
            if (!validation.hasNumber) requirements.push('1 number');
            
            strengthEl.innerHTML = `
                <div style="color: ${strength.color}; font-weight: 500;">Strength: ${strength.strength}</div>
                ${requirements.length > 0 ? `<div style="color: var(--red); font-size: 0.8rem;">Missing: ${requirements.join(', ')}</div>` : ''}
            `;
        }
        
        function showInputModal(title, message, placeholder = '', isPassword = false, validatePassword = false, currentPassword = null) {
            return new Promise((resolve) => {
                const modal = document.getElementById('input-modal');
                const titleEl = document.getElementById('input-modal-title');
                const messageEl = document.getElementById('input-modal-message');
                const inputEl = document.getElementById('input-modal-field');
                const validationEl = document.getElementById('input-modal-validation');
                const confirmBtn = document.getElementById('input-modal-confirm');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                inputEl.placeholder = placeholder;
                inputEl.type = isPassword ? 'password' : 'text';
                inputEl.value = '';
                validationEl.innerHTML = '';
                
                const updateValidation = () => {
                    if (!validatePassword || !inputEl.value) {
                        validationEl.innerHTML = '';
                        confirmBtn.disabled = false;
                        return;
                    }
                    
                    const password = inputEl.value;
                    const validation = validatePassword ? window.validatePassword(password) : { valid: true };
                    const strength = getPasswordStrength(password);
                    
                    let requirements = [];
                    if (!validation.minLength) requirements.push('6+ characters');
                    if (!validation.hasCapital) requirements.push('1 capital letter');
                    if (!validation.hasNumber) requirements.push('1 number');
                    
                    let samePassword = currentPassword && password === currentPassword;
                    if (samePassword) requirements.push('must be different from current');
                    
                    const isValid = validation.valid && !samePassword;
                    confirmBtn.disabled = !isValid;
                    
                    validationEl.innerHTML = `
                        <div style="color: ${strength.color}; font-weight: 500;">Strength: ${strength.strength}</div>
                        ${requirements.length > 0 ? `<div style="color: var(--red); font-size: 0.8rem;">Missing: ${requirements.join(', ')}</div>` : ''}
                    `;
                };
                
                const handleConfirm = () => {
                    const value = inputEl.value;
                    closeModal('input-modal');
                    cleanup();
                    resolve(value);
                };
                
                const handleCancel = () => {
                    closeModal('input-modal');
                    cleanup();
                    resolve(null);
                };
                
                const cleanup = () => {
                    confirmBtn.removeEventListener('click', handleConfirm);
                    modal.removeEventListener('click', handleModalClick);
                    inputEl.removeEventListener('keypress', handleKeyPress);
                    inputEl.removeEventListener('input', updateValidation);
                };
                
                const handleModalClick = (e) => {
                    if (e.target.dataset.modalClose === 'input-modal') handleCancel();
                };
                
                const handleKeyPress = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (inputEl.value && !confirmBtn.disabled) handleConfirm();
                    }
                };
                
                confirmBtn.addEventListener('click', handleConfirm);
                modal.addEventListener('click', handleModalClick);
                inputEl.addEventListener('keypress', handleKeyPress);
                
                if (validatePassword) {
                    inputEl.addEventListener('input', updateValidation);
                    window.validatePassword = validatePassword;
                }
                
                openModal('input-modal');
                inputEl.focus();
            });
        }
        
        function showConfirmModal(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                const titleEl = document.getElementById('confirm-modal-title');
                const messageEl = document.getElementById('confirm-modal-message');
                const confirmBtn = document.getElementById('confirm-modal-confirm');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                
                const handleConfirm = () => {
                    closeModal('confirm-modal');
                    cleanup();
                    resolve(true);
                };
                
                const handleCancel = () => {
                    closeModal('confirm-modal');
                    cleanup();
                    resolve(false);
                };
                
                const cleanup = () => {
                    confirmBtn.removeEventListener('click', handleConfirm);
                    modal.removeEventListener('click', handleModalClick);
                };
                
                const handleModalClick = (e) => {
                    if (e.target.dataset.modalClose === 'confirm-modal') handleCancel();
                };
                
                confirmBtn.addEventListener('click', handleConfirm);
                modal.addEventListener('click', handleModalClick);
                
                openModal('confirm-modal');
            });
        }
        
        async function handleChangePassword() {
            const currentPassword = await showInputModal('Change Password', 'Enter your current password:', 'Current password', true);
            if (!currentPassword) return;
            
            // Verify current password immediately
            try {
                const credential = EmailAuthProvider.credential(auth.currentUser.email, currentPassword);
                await reauthenticateWithCredential(auth.currentUser, credential);
            } catch (error) {
                showToast('Current password is incorrect');
                return;
            }
            
            const newPassword = await showInputModal('Change Password', 'Enter new password (min 6 chars, 1 capital, 1 number):', 'New password', true, validatePassword, currentPassword);
            if (!newPassword) return;
            
            try {
                await updatePassword(auth.currentUser, newPassword);
                showToast('Password updated successfully!');
            } catch (error) {
                showToast('Failed to update password: ' + error.message);
            }
        }
        
        async function handleChangeEmail() {
            const newEmail = await showInputModal('Change Email', 'Enter new email address:', 'New email');
            if (!newEmail) return;
            
            const password = await showInputModal('Change Email', 'Enter your current password to confirm:', 'Current password', true);
            if (!password) return;
            
            try {
                const credential = EmailAuthProvider.credential(auth.currentUser.email, password);
                await reauthenticateWithCredential(auth.currentUser, credential);
                await updateEmail(auth.currentUser, newEmail);
                await sendEmailVerification(auth.currentUser);
                showToast('Email updated! Please verify your new email address.');
            } catch (error) {
                showToast('Failed to update email: ' + error.message);
            }
        }
        
        async function handleDeleteAccount() {
            const confirmation = await showConfirmModal('Delete Account', 'Are you sure you want to delete your account? This action cannot be undone.');
            if (!confirmation) return;
            
            const password = await showInputModal('Delete Account', 'Enter your password to confirm account deletion:', 'Password', true);
            if (!password) return;
            
            try {
                const credential = EmailAuthProvider.credential(auth.currentUser.email, password);
                await reauthenticateWithCredential(auth.currentUser, credential);
                await deleteUser(auth.currentUser);
                showToast('Account deleted successfully.');
            } catch (error) {
                showToast('Failed to delete account: ' + error.message);
            }
        }

        function updateAuthUI(user) {
            const authBtn = document.getElementById('auth-btn');
            const signoutBtn = document.getElementById('signout-btn');
            const authStatus = document.getElementById('auth-status');
            const accountMgmt = document.getElementById('account-management');
            
            if (user) {
                isAnonymous = user.isAnonymous;
                
                if (!user.emailVerified) {
                    authBtn.style.display = 'none';
                    signoutBtn.style.display = 'inline-block';
                    accountMgmt.style.display = 'block';
                    authStatus.innerHTML = `<div style="background: var(--yellow); color: var(--dark-text); padding: 0.5rem; border-radius: 6px;">âš ï¸ Email not verified - ${user.email} <button onclick="sendVerificationEmail()" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; border: none; border-radius: 4px; background: var(--primary); color: white; cursor: pointer;">Resend</button></div>`;
                } else {
                    authBtn.style.display = 'none';
                    signoutBtn.style.display = 'inline-block';
                    accountMgmt.style.display = 'block';
                    authStatus.innerHTML = `<div style="background: var(--green); color: white; padding: 0.5rem; border-radius: 6px;">âœ“ Signed in as ${user.email}</div>`;
                }
            } else {
                authBtn.textContent = 'Sign In';
                authBtn.style.display = 'inline-block';
                signoutBtn.style.display = 'none';
                accountMgmt.style.display = 'none';
                authStatus.innerHTML = '<div style="background: var(--red); color: white; padding: 0.5rem; border-radius: 6px;">Not signed in</div>';
            }
        }
        
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }
        
        function openSubjectModal(subject = null) {
            const modal = document.getElementById('subject-modal');
            const title = modal.querySelector('#subject-modal-title');
            const idInput = modal.querySelector('#subject-modal-id');
            const nameInput = modal.querySelector('#subject-modal-name');
            const dayDropdown = modal.querySelector('#subject-modal-day-dropdown');
            const dayDisplay = modal.querySelector('#subject-modal-day-display');

            if (subject) {
                title.textContent = 'Edit Subject';
                idInput.value = subject.id;
                nameInput.value = subject.name;
                dayDisplay.textContent = subject.day;
                dayDropdown.dataset.value = subject.day;
            } else {
                title.textContent = 'Add Subject';
                idInput.value = '';
                nameInput.value = '';
                dayDisplay.textContent = 'Select a day...';
                dayDropdown.dataset.value = '';
            }
            openModal('subject-modal');
        }
        
        function openSemesterModal(semester = null) {
            const modal = document.getElementById('semester-modal');
            const title = modal.querySelector('#semester-modal-title');
            const idInput = modal.querySelector('#semester-modal-id');
            const nameInput = modal.querySelector('#semester-modal-name');
            const startDateInput = modal.querySelector('#semester-modal-start-date');
            const endDateInput = modal.querySelector('#semester-modal-end-date');

            if (semester) {
                title.textContent = 'Edit Semester';
                idInput.value = semester.id;
                nameInput.value = semester.name;
                startDateInput.value = semester.startDate || '';
                endDateInput.value = semester.endDate || '';
            } else {
                title.textContent = 'Add Semester';
                idInput.value = '';
                nameInput.value = '';
                startDateInput.value = '';
                endDateInput.value = '';
            }
            openModal('semester-modal');
        }

        function initializeNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = link.dataset.page;
                    navigateTo(page);
                });
            });
        }
        
        function navigateTo(pageName) {
            currentPage = pageName;
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.page === pageName);
            });
            
            // Update active page
            document.querySelectorAll('.page').forEach(page => {
                page.classList.toggle('active', page.dataset.page === pageName);
            });
            
            renderCurrentPage();
        }
        
        function renderCurrentPage() {
            if (!userId) return;
            
            renderHeader();
            
            switch (currentPage) {
                case 'Home':
                    renderHomePage();
                    break;
                case 'WeeklyReport':
                    renderWeeklyReportPage();
                    break;
                case 'Total':
                    renderTotalPage();
                    break;
                case 'Settings':
                    renderSettingsPage();
                    break;
            }
            
            // Re-attach button listeners after page render
            setTimeout(fixButtons, 100);
        }
        
        function renderHeader() {
            if (userProfile.name) {
                document.getElementById('user-info-name').textContent = `Hello, ${userProfile.name}`;
            }
            if (userProfile.major) {
                document.getElementById('user-info-major').textContent = userProfile.major;
            }
            
            const currentSem = allSemesters.find(s => s.id === currentSemesterId);
            if (currentSem) {
                document.getElementById('user-info-semester').textContent = currentSem.name;
            } else {
                document.getElementById('user-info-semester').textContent = "No semester selected";
            }
            
            updateStreakDisplay();
        }

        function renderHomePage() {
            const container = document.getElementById('home-content');
            const currentDate = getSelectedDateString();
            const dayName = getDayNameFromDate(currentDate);
            const isToday = currentDate === getTodayDateString();
            
            // Update date selector
            const availableDates = getAvailableDates();
            const dateOptionsContainer = document.getElementById('date-selector-options');
            const selectedDateDisplay = document.getElementById('selected-date-display');
            
            dateOptionsContainer.innerHTML = availableDates.map(date => 
                `<div class="dropdown-option" data-value="${date.dateString}">${date.displayName}</div>`
            ).join('');
            
            const selectedDateObj = availableDates.find(d => d.dateString === currentDate);
            selectedDateDisplay.textContent = selectedDateObj ? selectedDateObj.displayName : dayName;
            document.getElementById('date-selector-dropdown').dataset.value = currentDate;
            
            document.getElementById('home-day-title').textContent = 'Daily Attendance';
            
            // Check if current date is within semester range
            const currentSem = allSemesters.find(s => s.id === currentSemesterId);
            if (currentSem && currentSem.startDate && currentSem.endDate) {
                const semesterStart = new Date(currentSem.startDate);
                const semesterEnd = new Date(currentSem.endDate);
                const selectedDateObj = new Date(currentDate);
                
                if (selectedDateObj < semesterStart || selectedDateObj > semesterEnd) {
                    container.innerHTML = `<div class="no-data-message">Current date is outside of the selected semester period (${currentSem.startDate} to ${currentSem.endDate}).</div>`;
                    return;
                }
            }
            
            const subjectsForDay = allSubjects.filter(s => s.day === dayName && s.semesterId === currentSemesterId);
            const attendanceForDay = allAttendance.filter(r => r.date === currentDate);

            if (subjectsForDay.length === 0) {
                container.innerHTML = `<div class="no-data-message">No subjects scheduled for ${dayName}.</div>`;
                return;
            }
            
            // Check if date is more than 7 days ago
            const daysDiff = Math.floor((new Date(getTodayDateString()) - new Date(currentDate)) / (1000 * 60 * 60 * 24));
            const canEdit = daysDiff <= 7;
            
            if (!canEdit) {
                container.innerHTML = `<div class="no-data-message">Cannot edit attendance for dates older than 7 days.</div>`;
                return;
            }
            
            // Add bulk attendance option if multiple subjects
            let bulkAttendanceHtml = '';
            if (subjectsForDay.length > 1) {
                bulkAttendanceHtml = `
                    <div style="background: var(--light-grey); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem; text-align: center;">
                        <p style="margin-bottom: 0.75rem; font-weight: 500;">Mark all ${subjectsForDay.length} subjects at once:</p>
                        <div style="display: flex; gap: 0.75rem; justify-content: center; align-items: center; flex-wrap: wrap;">
                            <div class="custom-dropdown status-dropdown" id="bulk-status-dropdown" data-value="Present">
                                <div class="dropdown-selected status-present">
                                    <span>Present</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                                </div>
                                <div class="dropdown-options">
                                    <div class="dropdown-option" data-value="Present">Present</div>
                                    <div class="dropdown-option" data-value="Absent">Absent</div>
                                    <div class="dropdown-option" data-value="Permission">Permission</div>
                                    <div class="dropdown-option" data-value="Late">Late</div>
                                </div>
                            </div>
                            <button class="btn btn-green" id="bulk-submit-btn">Submit All</button>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = bulkAttendanceHtml + subjectsForDay.map((subject, index) => {
                const record = attendanceForDay.find(r => r.subjectId === subject.id);
                const status = record ? record.status : "Select";
                const statusClass = record ? `status-${status.toLowerCase()}` : "status-present";
                const isDisabled = !!record;
                
                return `
                <div class="data-row" id="subject-row-${subject.id}" style="animation-delay: ${index * 0.1}s;">
                    <span>${subject.name}</span>
                    <div class="subject-row-right">
                        <div class="custom-dropdown status-dropdown" data-value="${status}" data-subject-id="${subject.id}">
                            <div class="dropdown-selected ${statusClass}">
                                <span>${status}</span>
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                            </div>
                            <div class="dropdown-options">
                                <div class="dropdown-option" data-value="Present">Present</div>
                                <div class="dropdown-option" data-value="Absent">Absent</div>
                                <div class="dropdown-option" data-value="Permission">Permission</div>
                                <div class="dropdown-option" data-value="Late">Late</div>
                            </div>
                        </div>
                        <button class="tick-btn" data-subject-id="${subject.id}" title="Submit Attendance" ${isDisabled ? 'disabled' : ''}>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>
                        </button>
                    </div>
                </div>
                `;
            }).join('');
            
            container.querySelectorAll('.tick-btn').forEach(btn => {
                btn.addEventListener('click', handleSubmitAttendance);
            });
            
            // Add bulk submit event listener
            const bulkSubmitBtn = container.querySelector('#bulk-submit-btn');
            if (bulkSubmitBtn) {
                bulkSubmitBtn.addEventListener('click', () => {
                    const dropdown = container.querySelector('#bulk-status-dropdown');
                    const status = dropdown.dataset.value;
                    markAllSubjects(status);
                });
            }
        }
        
        async function handleSubmitAttendance(e) {
            const btn = e.currentTarget;
            const subjectId = btn.dataset.subjectId;
            const dropdown = document.querySelector(`.custom-dropdown[data-subject-id="${subjectId}"]`);
            const status = dropdown.dataset.value;
            
            if (status === 'Select') {
                showToast('Please select a status first.');
                return;
            }
            
            const todayDate = getTodayDateString();
            const currentSem = allSemesters.find(s => s.id === currentSemesterId);
            const semesterWeek = getSemesterWeek(todayDate, currentSem);
            
            const record = {
                subjectId: subjectId,
                semesterId: currentSemesterId,
                date: todayDate,
                status: status,
                semesterWeek: semesterWeek,
                createdAt: serverTimestamp()
            };
            
            try {
                showCuteLoader();
                btn.classList.add('loading');
                await addDoc(collection(db, paths.attendance()), record);
                hideCuteLoader();
                btn.classList.remove('loading');
                showToast('Attendance saved! ðŸ’•');
                
                // Update streak after saving attendance
                setTimeout(() => {
                    updateStreak();
                    checkWarningStatus();
                }, 1000);
            } catch (error) {
                console.error("Error saving attendance: ", error);
                hideCuteLoader();
                btn.classList.remove('loading');
                showToast('Error saving attendance.');
            }
        }

        function renderWeeklyReportPage() {
            const currentSemAttendance = allAttendance.filter(r => r.semesterId === currentSemesterId);
            const currentSem = allSemesters.find(s => s.id === currentSemesterId);
            
            const uniqueWeeks = [...new Set(currentSemAttendance.map(r => r.semesterWeek))];
            const validWeeks = uniqueWeeks.filter(w => w != null).sort((a, b) => b - a);
            
            const weekOptionsContainer = document.getElementById('week-selector-options');
            if (validWeeks.length > 0) {
                weekOptionsContainer.innerHTML = validWeeks.map(week => {
                    return `<div class="dropdown-option" data-value="${week}">Week ${week}</div>`;
                }).join('');
            } else {
                weekOptionsContainer.innerHTML = `<div class="dropdown-option" data-value="">No data</div>`;
            }
            
            const currentSemesterWeek = getSemesterWeek(getTodayDateString(), currentSem);
            
            const weekDropdown = document.getElementById('week-selector-dropdown');
            const selectedWeekDisplay = document.getElementById('selected-week-display');
            
            let weekToDisplay = currentSemesterWeek;
            if (currentSemesterWeek && validWeeks.includes(currentSemesterWeek)) {
                weekDropdown.dataset.value = currentSemesterWeek;
                selectedWeekDisplay.textContent = `Week ${currentSemesterWeek}`;
            } else if (validWeeks.length > 0) {
                weekToDisplay = validWeeks[0];
                weekDropdown.dataset.value = weekToDisplay;
                selectedWeekDisplay.textContent = `Week ${weekToDisplay}`;
            } else {
                weekDropdown.dataset.value = currentSemesterWeek || 1;
                selectedWeekDisplay.textContent = `Week ${currentSemesterWeek || 1}`;
            }

            const selectedWeek = parseInt(weekDropdown.dataset.value, 10);
            const weeklyData = currentSemAttendance.filter(r => r.semesterWeek === selectedWeek);
            
            const counts = {
                Present: 0,
                Absent: 0,
                Permission: 0,
                Late: 0
            };
            
            weeklyData.forEach(r => {
                if (counts.hasOwnProperty(r.status)) {
                    counts[r.status]++;
                }
            });
            
            document.getElementById('weekly-present').textContent = counts.Present;
            document.getElementById('weekly-absent').textContent = counts.Absent;
            document.getElementById('weekly-permission').textContent = counts.Permission;
            document.getElementById('weekly-late').textContent = counts.Late;
            
            // Calculate semester totals for warning system
            const semesterTotals = {
                Present: 0,
                Absent: 0,
                Permission: 0,
                Late: 0
            };
            
            currentSemAttendance.forEach(r => {
                if (semesterTotals.hasOwnProperty(r.status)) {
                    semesterTotals[r.status]++;
                }
            });
            
            const warning = calculateWarning(semesterTotals.Late, semesterTotals.Permission, semesterTotals.Absent);
            const warningEl = document.getElementById('weekly-warning');
            warningEl.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 0.5rem;">Semester Status:</div>
                <div style="color: ${warning.color}; font-weight: 500;">${warning.status}</div>
                <div style="font-size: 0.9rem; color: var(--grey-text); margin-top: 0.5rem;">
                    Total: ${semesterTotals.Absent} absent, ${semesterTotals.Permission} permission, ${semesterTotals.Late} late
                </div>
            `;
        }
        
        document.getElementById('week-selector-dropdown').addEventListener('change', renderWeeklyReportPage);
        document.getElementById('date-selector-dropdown').addEventListener('change', (e) => {
            selectedDate = e.currentTarget.dataset.value === getTodayDateString() ? null : e.currentTarget.dataset.value;
            renderHomePage();
        });

        function renderTotalPage() {
            const container = document.getElementById('total-content');
            const currentSemSubjects = allSubjects.filter(s => s.semesterId === currentSemesterId);
            const currentSemAttendance = allAttendance.filter(r => r.semesterId === currentSemesterId);
            
            if (currentSemSubjects.length === 0) {
                container.innerHTML = `<div class="no-data-message">No subjects found for this semester.</div>`;
                return;
            }
            
            container.innerHTML = currentSemSubjects.map((subject, index) => {
                // Get ALL attendance records for this subject across the ENTIRE semester
                const subjectAttendance = currentSemAttendance.filter(r => r.subjectId === subject.id);
                
                // Count TOTAL occurrences across all weeks in the semester
                const counts = {
                    Present: 0,
                    Absent: 0,
                    Permission: 0,
                    Late: 0
                };
                
                subjectAttendance.forEach(r => {
                    if (counts.hasOwnProperty(r.status)) {
                        counts[r.status]++;
                    }
                });
                
                // Calculate warning based on SEMESTER TOTALS
                const warning = calculateWarning(counts.Late, counts.Permission, counts.Absent);
                
                return `
                <div class="total-subject-row">
                    <div class="data-row" style="animation-delay: ${index * 0.1}s;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">${subject.name}</div>
                            <div style="font-size: 0.9rem; color: ${warning.color}; font-weight: 500;">${warning.status}</div>
                        </div>
                        <div class="data-row-right">
                            <div class="count-bubble count-green">${counts.Present}</div>
                            <div class="count-bubble count-red">${counts.Absent}</div>
                            <div class="count-bubble count-blue">${counts.Permission}</div>
                            <div class="count-bubble count-yellow">${counts.Late}</div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderSettingsPage() {
            document.getElementById('setting-name').value = userProfile.name || '';
            document.getElementById('setting-major').value = userProfile.major || '';
            
            const semesterOptionsContainer = document.getElementById('current-semester-options');
            const semesterListContainer = document.getElementById('semesters-list');
            const currentSemesterDisplay = document.getElementById('current-semester-display');
            
            if (allSemesters.length > 0) {
                semesterOptionsContainer.innerHTML = allSemesters.map(s => 
                    `<div class="dropdown-option" data-value="${s.id}">${s.name}</div>`
                ).join('');
                
                semesterListContainer.innerHTML = allSemesters.map(s => `
                    <div class="settings-list-item" data-id="${s.id}">
                        <div>
                            <strong>${s.name}</strong><br>
                            <small style="color: var(--grey-text);">${s.startDate || 'No start date'} to ${s.endDate || 'No end date'}</small>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-edit-semester">Edit</button>
                            <button class="btn btn-red btn-delete-semester">Delete</button>
                        </div>
                    </div>
                `).join('');
                
                const currentSem = allSemesters.find(s => s.id === currentSemesterId);
                if (currentSem) {
                    currentSemesterDisplay.textContent = currentSem.name;
                    document.getElementById('current-semester-dropdown').dataset.value = currentSem.id;
                } else {
                    currentSemesterDisplay.textContent = 'Select a semester...';
                }
                
            } else {
                semesterOptionsContainer.innerHTML = `<div class="dropdown-option">No semesters</div>`;
                semesterListContainer.innerHTML = `<div class="no-data-message">No semesters added yet.</div>`;
                currentSemesterDisplay.textContent = 'Add a semester...';
            }
            
            const subjectsListContainer = document.getElementById('subjects-list');
            const currentSemSubjects = allSubjects.filter(s => s.semesterId === currentSemesterId);
            
            if (currentSemSubjects.length > 0) {
                subjectsListContainer.innerHTML = currentSemSubjects.map(s => `
                    <div class="settings-list-item" data-id="${s.id}">
                        <span><strong>${s.name}</strong> (${s.day})</span>
                        <div class="btn-group">
                            <button class="btn btn-edit-subject">Edit</button>
                            <button class="btn btn-red btn-delete-subject">Delete</button>
                        </div>
                    </div>
                `).join('');
            } else {
                subjectsListContainer.innerHTML = `<div class="no-data-message">No subjects added for this semester.</div>`;
            }
            
            // Update max-height for expanded sections after content change
            setTimeout(() => {
                updateExpandedSections();
            }, 50);
            
            // Reinitialize collapse functionality
            reinitializeCollapse();
            
            addSettingsEventListeners();
        }
        
        function updateExpandedSections() {
            document.querySelectorAll('.settings-content:not(.collapsed)').forEach(content => {
                content.style.maxHeight = content.scrollHeight + 'px';
            });
        }
        
        function reinitializeCollapse() {
            document.querySelectorAll('.settings-header.collapsible').forEach(header => {
                // Clone node to remove all event listeners
                const newHeader = header.cloneNode(true);
                header.parentNode.replaceChild(newHeader, header);
                
                // Add fresh event listener
                newHeader.addEventListener('click', handleCollapseClick);
            });
        }
        
        function handleCollapseClick(e) {
            if (e.target.closest('button')) return;
            
            const header = e.currentTarget;
            const collapseId = header.dataset.collapse;
            const content = document.getElementById(collapseId + '-content');
            
            if (!content) {
                console.error('Content element not found:', collapseId + '-content');
                return;
            }
            
            const isCollapsed = content.classList.contains('collapsed');
            
            if (isCollapsed) {
                content.style.maxHeight = content.scrollHeight + 'px';
                content.classList.remove('collapsed');
                header.classList.remove('collapsed');
            } else {
                content.style.maxHeight = '0px';
                content.classList.add('collapsed');
                header.classList.add('collapsed');
            }
        }
        
        function addSettingsEventListeners() {
            document.getElementById('save-profile-btn').removeEventListener('click', handleSaveProfile);
            document.getElementById('current-semester-dropdown').removeEventListener('change', handleCurrentSemesterChange);
            
            document.getElementById('save-profile-btn').addEventListener('click', handleSaveProfile);
            document.getElementById('current-semester-dropdown').addEventListener('change', handleCurrentSemesterChange);
            
            // Account management buttons
            const changePasswordBtn = document.getElementById('change-password-btn');
            const changeEmailBtn = document.getElementById('change-email-btn');
            const deleteAccountBtn = document.getElementById('delete-account-btn');
            
            if (changePasswordBtn) changePasswordBtn.addEventListener('click', handleChangePassword);
            if (changeEmailBtn) changeEmailBtn.addEventListener('click', handleChangeEmail);
            if (deleteAccountBtn) deleteAccountBtn.addEventListener('click', handleDeleteAccount);
            
            // Form navigation for profile inputs
            document.getElementById('setting-name').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('setting-major').focus();
                }
            });
            document.getElementById('setting-major').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const name = document.getElementById('setting-name').value;
                    const major = document.getElementById('setting-major').value;
                    if (name && major) handleSaveProfile();
                }
            });
            
            document.querySelectorAll('.btn-edit-semester').forEach(btn => btn.addEventListener('click', (e) => {
                const id = e.target.closest('.settings-list-item').dataset.id;
                const semester = allSemesters.find(s => s.id === id);
                openSemesterModal(semester);
            }));
            
            document.querySelectorAll('.btn-delete-semester').forEach(btn => btn.addEventListener('click', (e) => {
                const id = e.target.closest('.settings-list-item').dataset.id;
                handleDeleteSemester(id);
            }));
            
            document.querySelectorAll('.btn-edit-subject').forEach(btn => btn.addEventListener('click', (e) => {
                const id = e.target.closest('.settings-list-item').dataset.id;
                const subject = allSubjects.find(s => s.id === id);
                openSubjectModal(subject);
            }));
            
            document.querySelectorAll('.btn-delete-subject').forEach(btn => btn.addEventListener('click', (e) => {
                const id = e.target.closest('.settings-list-item').dataset.id;
                handleDeleteSubject(id);
            }));
        }
        
        async function handleSaveProfile() {
            const name = document.getElementById('setting-name').value;
            const major = document.getElementById('setting-major').value;
            const btn = document.getElementById('save-profile-btn');
            
            try {
                btn.classList.add('loading');
                await setDoc(doc(db, paths.userProfile()), { name, major }, { merge: true });
                btn.classList.remove('loading');
                showToast('Profile saved! âœ¨');
            } catch (error) {
                console.error("Error saving profile: ", error);
                btn.classList.remove('loading');
                showToast('Error saving profile.');
            }
        }
        
        async function handleCurrentSemesterChange(e) {
            const newSemesterId = e.currentTarget.dataset.value;
            try {
                await setDoc(doc(db, paths.userProfile()), { currentSemesterId: newSemesterId }, { merge: true });
                showToast('Current semester updated!');
            } catch (error) {
                console.error("Error updating current semester: ", error);
                showToast('Error updating semester.');
            }
        }
        
        async function handleSaveSemester() {
            const id = document.getElementById('semester-modal-id').value;
            const name = document.getElementById('semester-modal-name').value;
            const startDate = document.getElementById('semester-modal-start-date').value;
            const endDate = document.getElementById('semester-modal-end-date').value;
            const btn = document.getElementById('save-semester-btn');
            
            if (!name || !startDate || !endDate) {
                showToast('Please enter a name, start date, and end date.');
                return;
            }
            
            // Validate that end date is not before start date
            if (new Date(endDate) < new Date(startDate)) {
                showToast('End date cannot be before start date.');
                return;
            }
            
            // Validate that semester is not longer than 6 months
            const start = new Date(startDate);
            const end = new Date(endDate);
            const sixMonthsLater = new Date(start);
            sixMonthsLater.setMonth(start.getMonth() + 6);
            
            if (end > sixMonthsLater) {
                showToast('Semester cannot be longer than 6 months.');
                return;
            }
            
            const semesterData = { name, startDate, endDate };
            
            try {
                btn.classList.add('loading');
                if (id) {
                    await setDoc(doc(db, paths.semesterDoc(id)), semesterData, { merge: true });
                } else {
                    await addDoc(collection(db, paths.semesters()), semesterData);
                }
                btn.classList.remove('loading');
                showToast('Semester saved! ðŸŒ¸');
                closeModal('semester-modal');
            } catch (error) {
                console.error("Error saving semester: ", error);
                btn.classList.remove('loading');
                showToast('Error saving semester.');
            }
        }
        
        async function handleDeleteSemester(id) {
            const semester = allSemesters.find(s => s.id === id);
            const confirmed = await showConfirmModal('Delete Semester', `Are you sure you want to delete "${semester?.name || 'this semester'}"? This action cannot be undone.`);
            if (!confirmed) return;
            
            try {
                await deleteDoc(doc(db, paths.semesterDoc(id)));
                showToast('Semester deleted.');
            } catch (error) {
                console.error("Error deleting semester: ", error);
                showToast('Error deleting semester.');
            }
        }
        
        async function handleSaveSubject() {
            const id = document.getElementById('subject-modal-id').value;
            const name = document.getElementById('subject-modal-name').value;
            const day = document.getElementById('subject-modal-day-dropdown').dataset.value;
            const btn = document.getElementById('save-subject-btn');
            
            if (!name || !day || !currentSemesterId) {
                showToast('Please fill all fields and select a semester.');
                return;
            }
            
            // Check for duplicate subject on same day (only for new subjects)
            if (!id) {
                const duplicateSubject = allSubjects.find(s => 
                    s.semesterId === currentSemesterId && 
                    s.day === day && 
                    s.name.toLowerCase() === name.toLowerCase()
                );
                
                if (duplicateSubject) {
                    showToast(`"${name}" already exists on ${day}. Please choose a different name or day.`);
                    return;
                }
            }
            
            const subjectData = {
                name,
                day,
                semesterId: currentSemesterId
            };
            
            try {
                btn.classList.add('loading');
                if (id) {
                    await setDoc(doc(db, paths.subjectDoc(id)), subjectData, { merge: true });
                } else {
                    await addDoc(collection(db, paths.subjects()), subjectData);
                }
                btn.classList.remove('loading');
                showToast('Subject saved! ');
                closeModal('subject-modal');
            } catch (error) {
                console.error("Error saving subject: ", error);
                btn.classList.remove('loading');
                showToast('Error saving subject.');
            }
        }
        
        async function handleDeleteSubject(id) {
            const subject = allSubjects.find(s => s.id === id);
            const confirmed = await showConfirmModal('Delete Subject', `Are you sure you want to delete "${subject?.name || 'this subject'}"? This action cannot be undone.`);
            if (!confirmed) return;
            
            try {
                await deleteDoc(doc(db, paths.subjectDoc(id)));
                showToast('Subject deleted.');
            } catch (error) {
                console.error("Error deleting subject: ", error);
                showToast('Error deleting subject.');
            }
        }
        
        function loadUserProfile() {
            onSnapshot(doc(db, paths.userProfile()), (docSnap) => {
                if (docSnap.exists()) {
                    userProfile = docSnap.data();
                    currentSemesterId = userProfile.currentSemesterId || null;
                } else {
                    setDoc(doc(db, paths.userProfile()), {
                        name: "Student",
                        major: "Your Major",
                        currentSemesterId: null
                    }, { merge: true });
                }
                renderCurrentPage();
            }, (error) => console.error("Error loading profile:", error));
        }
        
        function loadSemesters() {
            onSnapshot(collection(db, paths.semesters()), (snapshot) => {
                allSemesters = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCurrentPage();
            }, (error) => console.error("Error loading semesters:", error));
        }
        
        function loadSubjects() {
            onSnapshot(collection(db, paths.subjects()), (snapshot) => {
                allSubjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCurrentPage();
            }, (error) => console.error("Error loading subjects:", error));
        }
        
        function loadAttendance() {
            onSnapshot(collection(db, paths.attendance()), (snapshot) => {
                allAttendance = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCurrentPage();
                updateStreakDisplay();
            }, (error) => console.error("Error loading attendance:", error));
        }
        
        async function handleAuth() {
            auth = getAuth();
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("User is authenticated:", user.uid);
                    userId = user.uid;
                    updateAuthUI(user);
                    
                    loadUserProfile();
                    loadSemesters();
                    loadSubjects();
                    loadAttendance();
                    
                    navigateTo('Home');
                    
                    // Fix buttons after everything loads
                    setTimeout(fixButtons, 1000);
                    
                    // Request notification permission immediately after login
                    if ('Notification' in window && Notification.permission === 'default') {
                        requestNotificationPermission();
                    } else if (Notification.permission === 'granted') {
                        scheduleNotifications();
                    }
                } else {
                    console.log("User not authenticated");
                    updateAuthUI(null);
                    openModal('auth-modal');
                }
            });
        }

        async function initApp() {
            try {
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === '<your-api-key>') {
                    document.body.innerHTML = "<h1>Error: Firebase config is missing or invalid.</h1>";
                    console.error("Firebase config is missing or invalid.");
                    return;
                }
                
                console.log('Fetching real time...');
                await fetchRealTime();
                
                console.log('Initializing Firebase...');
                setLogLevel('debug');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                console.log('Initializing UI components...');
                initializeNavigation();
                initializeCustomDropdowns();
                initializeDatePickers();
                initializeModals();
                initializeAuth();
                
                console.log('Handling authentication...');
                await handleAuth();
                
                console.log('Setting up time sync...');
                setInterval(fetchRealTime, 60 * 60 * 1000);
                
                console.log('App initialization complete');
            } catch (error) {
                console.error('Error in initApp:', error);
                throw error;
            }
        }

        // Theme management
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const savedColorScheme = localStorage.getItem('colorScheme') || 'default';
            const savedFont = localStorage.getItem('font') || 'philosopher';
            
            // Ensure default font is applied for new users
            if (!localStorage.getItem('font')) {
                localStorage.setItem('font', 'philosopher');
            }
            
            document.documentElement.setAttribute('data-theme', savedTheme);
            if (savedColorScheme !== 'default') {
                document.documentElement.setAttribute('data-color-scheme', savedColorScheme);
            }
            document.documentElement.setAttribute('data-font', savedFont);
            
            updateThemeIcon(savedTheme);
            
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            
            // Initialize personalization dropdowns
            document.getElementById('color-scheme-dropdown').addEventListener('change', handleColorSchemeChange);
            document.getElementById('font-dropdown').addEventListener('change', handleFontChange);
            
            // Set initial dropdown values
            document.getElementById('color-scheme-dropdown').dataset.value = savedColorScheme;
            document.getElementById('color-scheme-display').textContent = getColorSchemeName(savedColorScheme);
            document.getElementById('font-dropdown').dataset.value = savedFont;
            document.getElementById('font-display').textContent = getFontName(savedFont);
        }
        
        function getColorSchemeName(scheme) {
            const names = {
                'default': 'Default',
                'ocean': 'Ocean Blue',
                'forest': 'Forest Green',
                'sunset': 'Sunset Orange'
            };
            return names[scheme] || 'Default';
        }
        
        function getFontName(font) {
            const names = {
                'philosopher': 'Philosopher',
                'inter': 'Inter',
                'roboto': 'Roboto'
            };
            return names[font] || 'Philosopher';
        }
        
        function handleColorSchemeChange(e) {
            const scheme = e.currentTarget.dataset.value;
            if (scheme === 'default') {
                document.documentElement.removeAttribute('data-color-scheme');
            } else {
                document.documentElement.setAttribute('data-color-scheme', scheme);
            }
            localStorage.setItem('colorScheme', scheme);
        }
        
        function handleFontChange(e) {
            const font = e.currentTarget.dataset.value;
            document.documentElement.setAttribute('data-font', font);
            localStorage.setItem('font', font);
        }
        
        // Collapse functionality
        function initializeCollapse() {
            // Set initial max-height for all content
            document.querySelectorAll('.settings-content').forEach(content => {
                if (!content.classList.contains('collapsed')) {
                    content.style.maxHeight = content.scrollHeight + 'px';
                }
            });
            
            reinitializeCollapse();
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }
        
        function updateThemeIcon(theme) {
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');
            
            if (theme === 'dark') {
                sunIcon.style.display = 'block';
                moonIcon.style.display = 'none';
            } else {
                sunIcon.style.display = 'none';
                moonIcon.style.display = 'block';
            }
        }

        // Report problem functionality
        function initializeReportProblem() {
            document.getElementById('report-problem-btn').addEventListener('click', (e) => {
                e.preventDefault();
                openModal('report-modal');
            });
            
            document.getElementById('contact-us-btn').addEventListener('click', (e) => {
                e.preventDefault();
                showContactToast();
            });
            
            document.getElementById('submit-report-btn').addEventListener('click', handleSubmitReport);
        }
        
        async function handleSubmitReport() {
            const type = document.getElementById('report-type-dropdown').dataset.value;
            const description = document.getElementById('report-description').value;
            
            if (!type || !description.trim()) {
                showToast('Please select a problem type and provide a description.');
                return;
            }
            
            const reportData = {
                type,
                description: description.trim(),
                email: auth.currentUser?.email || 'anonymous',
                userAgent: navigator.userAgent,
                timestamp: new Date().toISOString(),
                userId: userId || 'anonymous'
            };
            
            try {
                await addDoc(collection(db, 'bug-reports'), reportData);
                showToast('Report submitted successfully! Thank you for your feedback.');
                closeModal('report-modal');
                
                // Clear form
                document.getElementById('report-type-dropdown').dataset.value = '';
                document.getElementById('report-type-display').textContent = 'Select problem type...';
                document.getElementById('report-description').value = '';
            } catch (error) {
                console.error('Error submitting report:', error);
                showToast('Failed to submit report. Please try again.');
            }
        }

        // Excel export functionality
        function initializeExport() {
            document.getElementById('export-type-dropdown').addEventListener('change', handleExportSelection);
        }
        
        function handleExportSelection(e) {
            const exportType = e.currentTarget.dataset.value;
            if (exportType) {
                exportToExcel(exportType);
                // Reset dropdown
                e.currentTarget.dataset.value = '';
                document.getElementById('export-type-display').textContent = 'Export to Excel';
            }
        }
        
        function exportToExcel(type) {
            const currentSem = allSemesters.find(s => s.id === currentSemesterId);
            if (!currentSem) {
                showToast('Please select a semester first.');
                return;
            }
            
            const currentSemAttendance = allAttendance.filter(r => r.semesterId === currentSemesterId);
            const currentSemSubjects = allSubjects.filter(s => s.semesterId === currentSemesterId);
            
            let filteredData = currentSemAttendance;
            let filename = `${currentSem.name}_${type}_attendance`;
            
            // Filter data based on export type
            if (type === 'weekly') {
                const currentWeek = getSemesterWeek(getTodayDateString(), currentSem);
                filteredData = currentSemAttendance.filter(r => r.semesterWeek === currentWeek);
                filename += `_week${currentWeek}`;
            } else if (type === 'monthly') {
                const currentMonth = new Date().getMonth();
                filteredData = currentSemAttendance.filter(r => new Date(r.date).getMonth() === currentMonth);
                filename += `_${new Date().toLocaleString('default', { month: 'long' })}`;
            }
            
            // Create CSV content
            let csvContent = 'Date,Subject,Status,Week\n';
            
            filteredData.forEach(record => {
                const subject = currentSemSubjects.find(s => s.id === record.subjectId);
                const subjectName = subject ? subject.name : 'Unknown Subject';
                csvContent += `${record.date},${subjectName},${record.status},${record.semesterWeek || 'N/A'}\n`;
            });
            
            // Add summary
            csvContent += '\n\nSUMMARY\n';
            csvContent += 'Subject,Present,Absent,Permission,Late,Total,Percentage\n';
            
            currentSemSubjects.forEach(subject => {
                const subjectRecords = filteredData.filter(r => r.subjectId === subject.id);
                const counts = { Present: 0, Absent: 0, Permission: 0, Late: 0 };
                
                subjectRecords.forEach(r => {
                    if (counts.hasOwnProperty(r.status)) counts[r.status]++;
                });
                
                const total = Object.values(counts).reduce((a, b) => a + b, 0);
                const percentage = total > 0 ? ((counts.Present / total) * 100).toFixed(1) : '0.0';
                
                csvContent += `${subject.name},${counts.Present},${counts.Absent},${counts.Permission},${counts.Late},${total},${percentage}%\n`;
            });
            
            // Download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename + '.csv';
            link.click();
            
            showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} report exported successfully!`);
        }

        // Fix button functionality after page renders
        function fixButtons() {
            const addSubjectBtn = document.getElementById('add-subject-btn');
            if (addSubjectBtn) {
                addSubjectBtn.onclick = () => openSubjectModal();
            }
            
            const addSemesterBtn = document.getElementById('add-semester-btn');
            if (addSemesterBtn) {
                addSemesterBtn.onclick = () => openSemesterModal();
            }
            
            const signoutBtn = document.getElementById('signout-btn');
            if (signoutBtn) {
                signoutBtn.onclick = () => handleSignOut();
            }
            
            const authBtn = document.getElementById('auth-btn');
            if (authBtn) {
                authBtn.onclick = () => openModal('auth-modal');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            try {
                console.log('Initializing app...');
                
                // Fix buttons initially
                setTimeout(fixButtons, 1000);
                
                initializeTheme();
                initializeCollapse();
                initializeReportProblem();
                initializeExport();
                initApp();
                console.log('App initialized successfully');
            } catch (error) {
                console.error('Error during app initialization:', error);
                // Show user-friendly error message
                document.body.innerHTML = `
                    <div style="padding: 2rem; text-align: center; font-family: Arial, sans-serif;">
                        <h2>âš ï¸ Application Error</h2>
                        <p>There was an error loading the application. Please refresh the page.</p>
                        <button onclick="location.reload()" style="padding: 0.5rem 1rem; margin-top: 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Refresh Page</button>
                    </div>
                `;
            }
        });

    </script>
</body>
</html>